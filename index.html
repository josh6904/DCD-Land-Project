<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DCD Possess The Land | Fundraising</title>
    <style>
        /* --- CSS VARIABLES & RESET --- */
        :root {
            --primary: #059669;
            --primary-dark: #064E3B;
            --primary-light: #34D399;
            --secondary: #3B82F6;
            --accent: #F59E0B;
            --danger: #EF4444;
            --bg: #F3F4F6;
            --surface: #FFFFFF;
            --text-main: #111827;
            --text-sub: #6B7280;
            --border: #E5E7EB;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
        
        body { 
            background-color: var(--bg); 
            color: var(--text-main); 
            display: flex; 
            height: 100vh; 
            overflow: hidden;
        }

        /* --- LAYOUT --- */
        aside {
            width: 280px;
            background: #111827;
            color: white;
            display: flex;
            flex-direction: column;
            padding: 24px;
            z-index: 50;
            box-shadow: 2px 0 4px 6px rgba(0,0,0,0.15);
        }

        main { 
            flex: 1; 
            overflow-y: auto; 
            padding: 32px; 
            position: relative;
        }

        /* --- NAVIGATION --- */
        .brand { font-size: 1.2rem; font-weight: 800; margin-bottom: 40px; color: var(--primary); letter-spacing: 1px; display: flex; align-items: center; gap: 12px; }
        .nav-item { 
            padding: 14px; 
            margin-bottom: 8px; 
            border-radius: 8px; 
            cursor: pointer; 
            display: flex; 
            align-items: center; 
            gap: 12px; 
            color: #9CA3AF; 
            transition: all 0.2s; 
            font-size: 0.95rem;
        }
        .nav-item:hover { background: #374151; color: white; }
        .nav-item.active { background: var(--primary); color: white; font-weight: 600; }

        /* --- MOBILE RESPONSIVE --- */
        @media (max-width: 768px) {
            body { flex-direction: column; }
            aside { 
                width: 100%; 
                height: auto; 
                position: fixed; 
                bottom: 0; 
                left: 0; 
                flex-direction: row; 
                padding: 12px; 
                justify-content: space-around; 
                border-top: 1px solid var(--border); 
                background: white; 
                color: #333;
                box-shadow: 0 -2px 6px rgba(0,0,0,0.1);
                padding-bottom: 10px;
            }
            .brand { display: none; }
            .nav-item { flex-direction: column; gap: 4px; font-size: 0.75rem; text-align: center; padding: 8px; }
            main { padding-bottom: 80px; }
        }

        /* --- COMPONENTS --- */
        .card { 
            background: var(--surface); 
            padding: 24px; 
            border-radius: 12px; 
            border: 1px solid var(--border); 
            box-shadow: var(--shadow); 
            margin-bottom: 24px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .btn {
            padding: 12px 24px; 
            border-radius: 8px; 
            border: none; 
            cursor: pointer; 
            font-weight: 600;
            transition: all 0.2s ease; 
            display: inline-flex; 
            align-items: center; 
            gap: 8px; 
            justify-content: center;
        }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-dark); }
        .btn-primary:disabled { background: #9CA3AF; cursor: not-allowed; }
        .btn-secondary { background: white; border: 1px solid var(--border); color: var(--text-main); }
        .btn-secondary:hover { background: #f9fafb; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-sm { padding: 6px 12px; font-size: 0.85rem; }
        .btn-block { width: 100%; }

        input, select, textarea { 
            width: 100%; 
            padding: 14px; 
            border: 1px solid var(--border); 
            border-radius: 8px; 
            margin-bottom: 16px; 
            font-size: 1rem;
            transition: border-color 0.2s;
        }
        input:focus, select:focus, textarea:focus { 
            outline: 2px solid var(--primary); 
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(5, 150, 245, 0.1);
        }
        
        /* Progress Bars */
        .progress-track { 
            background: #E5E7EB; 
            height: 10px; 
            border-radius: 5px; 
            overflow: hidden; 
            margin-top: 8px; 
            position: relative;
        }
        .progress-fill { 
            height: 100%; 
            background: var(--primary); 
            width: 0%; 
            transition: width 0.5s ease; 
        }
        .progress-fill.amber { background: var(--accent); }
        .progress-fill.danger { background: var(--danger); }

        /* Tables */
        table { width: 100%; border-collapse: collapse; }
        th, td { 
            padding: 14px; 
            text-align: left; 
            border-bottom: 1px solid var(--border); 
            font-size: 0.9rem; 
        }
        th { background: #F9FAFB; color: var(--text-sub); font-weight: 600; text-transform: uppercase; font-size: 0.75rem; }
        tr:hover td { background: #fafafa; }
        .money { font-family: 'Courier New', monospace; font-weight: 600; color: var(--text-main); }
        .badge { padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 700; }
        .badge-success { background: var(--primary-light); color: var(--primary-dark); }
        .badge-warn { background: var(--accent); color: #92400E; }
        .badge-danger { background: #FEE2E2; color: var(--danger); }

        /* --- VIZUALS --- */
        .viz-grid { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 24px; 
        }

        .viz-card { 
            background: white; 
            padding: 24px; 
            border-radius: 12px; 
            border: 1px solid var(--border); 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
        }
        
        .donut-chart {
            width: 150px; height: 150px; 
            border-radius: 50%;
            background: conic-gradient(var(--primary) 0% 100%); 
            position: relative; 
            margin-bottom: 20px;
        }
        .donut-hole {
            width: 90px; height: 90px; 
            background: white; 
            border-radius: 50%;
            position: absolute; 
            top: 30px; left: 30px;
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center;
        }

        .stat-row {
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            font-size: 0.9rem; 
            margin-bottom: 10px;
        }

        /* --- TIMELINE --- */
        .phase-timeline { 
            border-left: 3px solid var(--border); 
            padding-left: 20px; 
            margin-left: 20px;
        }
        .phase-item { 
            position: relative; 
            margin-bottom: 40px; 
            padding-left: 20px; 
            border-left: 3px solid transparent; 
        }
        .phase-dot { 
            position: absolute; 
            left: -27px; 
            top: 5px; 
            width: 12px; 
            height: 12px; 
            border-radius: 50%; 
            background: var(--bg); 
            border: 3px solid var(--border);
        }
        .phase-item.active .phase-dot { border-color: var(--primary); background: var(--primary); }
        .phase-item.completed .phase-dot { border-color: var(--primary-dark); background: var(--primary-dark); }
        .phase-item.late .phase-dot { border-color: var(--danger); background: #FEE2E2; }

        /* --- MODAL --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); 
            display: none; 
            align-items: center; 
            justify-content: center; 
            z-index: 100;
            backdrop-filter: blur(4px);
        }
        .modal { 
            background: white; 
            width: 90%; 
            max-width: 550px; 
            padding: 32px; 
            border-radius: 16px; 
            box-shadow: 0 20px 25px rgba(0,0,0,0.15);
            animation: modalPop 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }
        @keyframes modalPop {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .form-grid-2 { grid-template-columns: 1fr 1fr; gap: 20px; }

        .loader {
            border: 3px solid var(--border);
            border-top: 3px solid transparent;
            border-radius: 50%;
            border-color: var(--primary);
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: none; /* Hidden by default */
            border-right-color: transparent;
            border-left-color: var(--primary);
            border-bottom: 3px solid transparent;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>

    <!-- SIDEBAR -->
    <aside>
        <div class="brand">üèù<br>DCD Possess<br>The Land</div>
        <div class="nav-group">
            <div class="nav-item active" onclick="app.navigate('dashboard')">üìä Dashboard</div>
            <div class="nav-item" onclick="app.navigate('leaderboard')">üèÜ Leaderboard</div>
            <div class="nav-item" onclick="app.navigate('pledges')">ü§ù Pledges</div>
            <div class="nav-item" onclick="app.navigate('ledger')">üí∞ Ledger</div>
            <div class="nav-item" onclick="app.navigate('tribes')">üè¢ Tribes</div>
            <div class="nav-item" onclick="app.navigate('settings')">‚öôÔ∏è Settings</div>
        </div>
    </aside>

    <!-- MAIN CONTENT -->
    <main>
        
        <!-- DASHBOARD VIEW -->
        <section id="view-dashboard">
            <header class="flex-between">
                <div>
                    <h1>Project Overview</h1>
                    <p class="text-sub">Real-time status for DCD Possess The Land</p>
                </div>
                <div style="display:flex; gap:12px;">
                    <button class="btn btn-danger" onclick="app.openModal('expense')">‚ûñ Expense</button>
                    <button class="btn btn-secondary" onclick="app.openModal('cash')">üíµ Add Cash</button>
                    <button class="btn btn-primary" onclick="app.openModal('pledge')">+ New Pledge</button>
                </div>
            </header>

            <!-- KPI CARDS -->
            <div class="viz-grid">
                <div class="viz-card">
                    <h4 style="color: var(--text-sub); margin-bottom: 10px;">Gross Cash</h4>
                    <div class="text-lg" id="dash-cash" style="color: var(--primary);">0</div>
                </div>
                <div class="viz-card">
                    <h4 style="color: var(--text-sub); margin-bottom: 10px;">Total Pledges</h4>
                    <div class="text-lg" id="dash-pledges">0</div>
                </div>
            </div>

            <!-- PHASE PROGRESS -->
            <div class="card">
                <div class="flex-between">
                    <h3>üìÖ Collection Phases</h3>
                    <button class="btn btn-secondary btn-sm" onclick="app.navigate('settings')">Edit Phases</button>
                </div>
                <div id="phase-timeline"></div>
            </div>

            <!-- RECENT ACTIVITY -->
            <div class="card">
                <h3>üî¥ Recent Activity</h3>
                <div id="recent-activity-list" style="display: flex; flex-direction: column; gap: 12px;">
                    <p class="text-sub" style="text-align: center;">No recent activity yet.</p>
                </div>
        </section>

        <!-- LEADERBOARD VIEW -->
        <section id="view-leaderboard" class="hidden">
            <h1>Department Leaderboard</h1>
            <div id="leaderboard-container" style="margin-top: 24px;">
                <!-- Populated by JS -->
            </div>
        </section>

        <!-- PLEDGES VIEW -->
        <section id="view-pledges" class="hidden">
            <div class="flex-between">
                <h1>Pledge Ledger</h1>
                <div style="display:flex; gap:12px;">
                    <button class="btn btn-secondary btn-sm" onclick="app.exportCSV('pledges')">üì• Export CSV</button>
                    <button class="btn btn-primary" onclick="app.openModal('pledge')">+ New Pledge</button>
                </div>
            </div>
            <div class="card" style="overflow: hidden; max-height: 60vh; overflow-y: auto;">
                <table style="width: 100%;">
                    <thead>
                        <tr>
                            <th>Member</th>
                            <th>Trial/Dept</th>
                            <th>Committed</th>
                            <th>Paid</th>
                            <th>Remaining</th>
                            <th>Status</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="pledges-body"></tbody>
                </table>
            </div>
        </section>

        <!-- LEDGER & RECONCILE VIEW -->
        <section id="view-ledger" class="hidden">
            <h1>Transaction Reconciliation</h1>
            
            <!-- PARSER UI -->
            <div class="card" style="border-left: 5px solid var(--primary);">
                <h3>ü§ñ M-Pesa SMS Parser</h3>
                <p class="text-sub" style="margin-bottom: 12px;">Paste your confirmation messages below.</p>
                
                <textarea 
                    id="sms-input" 
                    style="width: 100%; height: 120px; font-family: 'Courier New', monospace; font-size: 0.9rem;"
                    placeholder="Paste SMS here (e.g., 'You have received Ksh10,000 from John Doe...')..."
                ></textarea>
                
                <div style="display: flex; gap: 12px; margin-top: 16px;">
                    <button class="btn btn-secondary" onclick="app.clearParser()">Clear</button>
                    <button class="btn btn-primary" onclick="app.parseSMS()">‚ö° Extract</button>
                </div>

                <!-- Staged Area -->
                <div id="staged-container" style="display: none; margin-top: 20px; border-top: 1px solid var(--border); padding-top: 20px;">
                    <div class="flex-between">
                        <h4>Staged Transactions (<span id="staged-count">0</span>)</h4>
                        <button id="btn-add-all" class="btn btn-primary" onclick="app.commitAll()">‚úÖ Commit All</button>
                    </div>
                    <div class="loader" id="loading-spinner"></div>
                    <div id="staged-list" style="margin-top: 20px;"></div>
                </div>
            </div>

            <div class="flex-between" style="margin-top: 24px;">
                <h2>Audit Trail</h2>
                <button class="btn btn-secondary btn-sm" onclick="app.exportCSV('ledger')">üì• Export CSV</button>
            </div>

            <!-- ACTUAL LEDGER TABLE -->
            <div class="card" style="overflow: hidden; max-height: 50vh; overflow-y: auto;">
                <table style="width: 100%;">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Reference</th>
                            <th>Description</th>
                            <th>Amount</th>
                            <th>Type</th>
                        </tr>
                    </thead>
                    <tbody id="ledger-body"></tbody>
                </table>
            </div>
        </section>

        <!-- TRIBES VIEW -->
        <section id="view-tribes" class="hidden">
            <h1>Tribe Performance</h1>
            <div id="tribes-grid" class="viz-grid" style="margin-top: 24px;">
                <!-- Populated by JS -->
            </div>
        </section>

        <!-- SETTINGS VIEW -->
        <section id="view-settings" class="hidden">
            <h1>‚öôÔ∏è Admin</h1>
            
            <div class="card">
                <h3>Manage Collection Phases</h3>
                <p class="text-sub" style="margin-bottom: 12px;">Set deadlines and targets for your collection cycles.</p>
                
                <form onsubmit="app.addPhase(event)" class="form-grid-2">
                    <div>
                        <label style="font-weight: 600; color: var(--text-main);">Phase Name</label>
                        <input type="text" id="s-name" placeholder="e.g. March 8th Collection" required>
                    </div>
                    <div>
                        <label style="font-weight: 600; color: var(--text-main);">Target Date</label>
                        <input type="date" id="s-date" required>
                    </div>
                </form>

                <div style="margin-top: 20px; padding: 16px; background: #F9FAFB; border-radius: 8px;">
                    <strong>Current Phases:</strong>
                    <div id="phases-list"></div>
                </div>
            </div>

            <div class="card" style="border-color: var(--danger);">
                <h3 style="color: var(--danger);">Danger Zone</h3>
                <p class="text-sub">Reset entire project. This cannot be undone.</p>
                <button class="btn btn-danger" onclick="if(confirm('Are you sure?')) { store.reset(); location.reload(); }">Reset All Data</button>
            </div>
        </section>

    </main>

    <!-- MODAL: ADD PLEDGE -->
    <dialog id="modal-pledge">
        <form method="dialog">
            <h2 style="margin-bottom: 20px;">Add New Pledge</h2>
            
            <div class="form-grid">
                <div>
                    <label style="font-weight: 600; color: var(--text-main);">Member Name</label>
                    <input type="text" id="p-name" placeholder="John Doe" required autocomplete="off">
                </div>
                <div>
                    <label style="font-weight: 600; color: var(--text-main);">Department</label>
                    <select id="p-dept" required>
                        <option>Eagles</option>
                        <option>Daughters of Faith</option>
                        <option>Youth</option>
                        <option>Kingdom Generation</option>
                        <option>Planning Committee</option>
                    </select>
                </div>
            </div>

            <div style="margin-top: 20px; display: flex; justify-content: space-between;">
                <div class="form-grid-2">
                    <div>
                        <label style="font-weight: 600; color: var(--text-main);">Pledged Amount (KES)</label>
                        <input type="number" id="p-amount" min="0" placeholder="0.00" required>
                    </div>
                    <div style="display: flex; flex-direction: column; justify-content: center; gap: 8px;">
                        <small style="color: var(--text-sub);">* Auto-creates a member if not found.</small>
                    </div>
                </div>
            </div>

            <div style="display: flex; justify-content: flex-end; gap: 12px; margin-top: 20px;">
                <button class="btn btn-secondary" onclick="document.getElementById('modal-pledge').close()">Cancel</button>
                <button type="submit" class="btn btn-primary">Save Pledge</button>
            </div>
        </form>
    </dialog>

    <!-- MODAL: ADD CASH -->
    <dialog id="modal-cash">
        <form method="dialog">
            <h2 style="margin-bottom: 20px;">Record Cash Payment</h2>
            
            <div class="form-grid-2">
                <div>
                    <label style="font-weight: 600; color: var(--text-main);">Member Name</label>
                    <input type="text" id="c-name" placeholder="John Doe" required autocomplete="off">
                </div>
                <div>
                    <label style="font-style: normal; font-weight: 600; color: var(--text-main);">Amount (KES)</label>
                    <input type="number" id="c-amount" min="0" placeholder="0.00" required>
                </div>
            </div>

            <div style="display: flex; justify-content: flex-end; gap: 12px; margin-top: 20px;">
                <button class="btn btn-secondary" onclick="document.getElementById('modal-cash').close()">Cancel</button>
                <button type="submit" class="btn btn-primary">Record Payment</button>
            </div>
        </form>
    </dialog>

    <script>
        /**
         * Store: Manages LocalStorage and Data Logic
         */
        const DB_KEY = 'dcd_land_final_v13';

        const DEPARTMENTS = [
            "Eagles", 
            "Daughters of Faith", 
            "Youth", 
            "Kingdom Generation", 
            "Planning Committee"
        ];

        class Store {
            constructor() {
                const saved = localStorage.getItem(DB_KEY);
                this.data = saved ? JSON.parse(saved) : {
                    pledges: [],
                    transactions: [],
                    expenses: [],
                    phases: [
                        { 
                            id: 1, 
                            name: "March 8th Collection", 
                            date: "2024-03-08", 
                            totalTarget: 1000000,
                            targets: {
                                "Eagles": 200000,
                                "Daughters of Faith": 200000,
                                "Youth": 200000,
                                "Kingdom Generation": 200000,
                                "Planning Committee": 200000
                            }
                        }
                    ]
                };
            }

            save() {
                localStorage.setItem(DB_KEY, JSON.stringify(this.data));
                app.render();
            }

            addPledge(name, department, amount) {
                this.data.pledges.push({
                    id: Date.now(),
                    name, 
                    department, 
                    amount: Number(amount), 
                    redeemed: 0
                });
                this.save();
            }

            addTransaction(tx) {
                // 1. Find matching pledge
                let matchedPledge = null;
                // Use flexible matching to handle Josh vs Josh
                // Priority 1: Exact Name + Dept match (if dept provided)
                if (tx.department) {
                    matchedPledge = this.data.pledges.find(p => p.name.toLowerCase() === tx.name.toLowerCase() && p.department === tx.department);
                } 
                
                // Priority 2: Name match only (unique check)
                if (!matchedPledge) {
                    const allMatches = this.data.pledges.filter(p => p.name.toLowerCase() === tx.name.toLowerCase());
                    if (allMatches.length === 1) {
                        matchedPledge = allMatches[0];
                    }
                }

                if (matchedPledge) {
                    tx.name = matchedPledge.name; // Normalize name
                    tx.department = matchedPledge.department; // Normalize dept
                    tx.pledgeId = matchedPledge.id;
                    matchedPledge.redeemed = (matchedPledge.redeemed || 0) + tx.amount;
                } else {
                    tx.pledgeId = null;
                }

                this.data.transactions.unshift(tx);
                this.save();
            }

            addExpense(description, amount, category) {
                this.data.expenses.unshift({
                    id: Date.now(),
                    date: new Date().toISOString(),
                    description, amount: Number(amount), category
                });
                this.save();
            }

            addPhase(name, date, deptTargets) {
                // Validate non-negative
                for(let val of Object.values(deptTargets)) {
                    if(val < 0) { alert("Targets cannot be negative."); return; }
                }

                const total = Object.values(deptTargets).reduce((a,b) => a+b, 0);
                this.data.phases.push({
                    id: Date.now(),
                    name, date, totalTarget: total, targets: deptTargets
                });
                this.data.phases.sort((a,b) => new Date(a.date) - new Date(b.date));
                this.save();
            }

            deletePhase(id) {
                this.data.phases = this.data.phases.filter(p => p.id !== id);
                this.save();
            }

            reset() {
                localStorage.removeItem(DB_KEY);
                location.reload();
            }
        }

        const store = new Store();

        /**
         * UI Manager: Handles DOM manipulations and Event Listeners
         */
        const UI = {
            get: (id) => document.getElementById(id),
            
            showSection: (id) => {
                document.querySelectorAll('main section').forEach(el => el.classList.add('hidden'));
                const target = document.getElementById(`view-${id}`);
                if (target) target.classList.remove('hidden');
                
                // Update Nav
                document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
                // Try to find the nav item that triggered this (approximate based on structure)
                const navItems = document.querySelectorAll('.nav-item');
                navItems.forEach(el => {
                    // Check if this nav item contains text matching the view ID
                    if(el.textContent.toLowerCase().includes(id)) {
                        el.classList.add('active');
                    }
                });
            },

            showSpinner: (show, btnText) => {
                const btn = document.getElementById('btn-add-all');
                const loader = document.getElementById('loading-spinner');
                
                if (show) {
                    btn.disabled = true;
                    btn.innerText = "Processing...";
                    loader.style.display = 'inline-block';
                } else {
                    btn.disabled = false;
                    btn.innerText = "‚úÖ Commit All";
                    loader.style.display = 'none';
                }
            }
        };

        /**
         * Parser Logic: Robust M-Pesa Text Extraction
         */
        const Parser = {
            parse(text) {
                // 1. Regex Patterns
                // Matches "Received From" (Personal Account)
                // Matches "Sent To" (Till Number)
                
                const results = [];
                
                // Split by lines
                const lines = text.split('\n').filter(line => line.trim().length > 0);

                lines.forEach(line => {
                    let amount = null;
                    let name = "Unknown";
                    let ref = "N/A";
                    let type = "M-Pesa";

                    // 2. Attempt to parse "Received" format (Personal Account)
                    // Pattern: "You have received Ksh 10,000.00 from John Doe 0722..."
                    const receivedMatch = line.match(/You have received Ksh\s?([0-9,]+\.?\d*)\s+from\s+([A-Za-z\s]+?)(?:\s+(\d{10})/i);
                    
                    if (receivedMatch) {
                        amount = parseFloat(receivedMatch[1].replace(/,/g, '')); // Remove commas
                        name = receivedMatch[2] ? receivedMatch[2].trim() : "Unknown";
                        const phone = receivedMatch[3] || null; // Extract phone if available
                    } 
                    
                    // 3. Attempt to parse "Sent To" format (Till)
                    // Pattern: "Confirmed. Ksh 10,000.00 sent to LANDFUNDRAISER for account 567892..."
                    const sentMatch = line.match(/Ksh\s?([0-9,]+\.?\d*)\s+sent to\s+([A-Z\s]+)\s+for account\s+(\w+)/i);
                    
                    if (sentMatch) {
                        amount = parseFloat(sentMatch[1].replace(/,/g, ''));
                        name = "Till Transaction"; // Till payments usually don't have sender name in body
                        ref = sentMatch[3];
                        
                        // Extract Date if available
                        const dateMatch = line.match(/on\s+(\d{1,2}\/\d{2}\/\d{2})/i);
                        if(dateMatch) ref += ` (${dateMatch[1]})`;
                    }

                    if (amount) {
                        results.push({ amount, name, ref, phone, type });
                    }
                });

                return results;
            }
        };

        /**
         * App Logic: Controller
         */
        const app = {
            init: () => {
                app.render();
                // Add Listeners
                document.getElementById('btn-commit').addEventListener('click', app.commitAll);
                document.getElementById('sms-input').addEventListener('input', (e) => {
                    // Clear previous list on new input to allow re-parsing
                    app.clearParser();
                });
            },

            // --- Navigation ---
            navigate: (viewId) => {
                UI.showSection(viewId);
            },

            // --- Forms ---
            openModal: (modalId) => {
                const modal = document.getElementById(modalId);
                if(modal) {
                    modal.showModal();
                // Reset Form
                    const form = modal.querySelector('form');
                    if(form) form.reset();
                }
            },

            // --- Form Handling ---
            handlePledge: (e) => {
                e.preventDefault();
                const form = e.target;
                
                const name = form.querySelector('#p-name').value;
                const dept = form.querySelector('#p-dept').value;
                const amount = parseFloat(form.querySelector('#p-amount').value);
                
                if (!name || !amount) {
                    alert("Please fill in Name and Amount.");
                    return;
                }

                store.addPledge(name, dept, amount);
                document.getElementById('modal-pledge').close();
            },

            handleCash: (e) => {
                e.preventDefault();
                const form = e.target;
                
                const name = form.querySelector('#c-name').value;
                const amount = parseFloat(form.querySelector('#c-amount').value);
                const ref = 'CASH-' + Date.now();
                const dept = form.querySelector('#c-dept').value;

                if (!name || !amount) {
                    alert("Please fill in Name and Amount.");
                    return;
                }

                store.addTransaction({
                    amount, name, ref, department: dept, type: 'Cash'
                });
                document.getElementById('modal-cash').close();
            },

            handleExpense: (e) => {
                e.preventDefault();
                const form = e.target;
                const desc = form.querySelector('#e-desc').value;
                const amount = parseFloat(form.querySelector('#e-amount').value);
                const cat = form.querySelector('#e-cat').value;

                if(!desc || !amount) {
                    alert("Please fill in Description and Amount.");
                    return;
                }

                store.addExpense(desc, amount, cat);
                document.getElementById('modal-cash').close();
            },

            // --- Phases ---
            addPhase: (e) => {
                e.preventDefault();
                const form = e.target;
                
                const name = document.getElementById('s-name').value;
                const date = document.getElementById('s-date').value;
                
                const inputs = document.querySelectorAll('.target-input');
                const targets = {};
                inputs.forEach(i => { targets[i.dataset.dept] = Number(i.value) || 0; });

                store.addPhase(name, date, targets);
                document.getElementById('s-name').value = '';
                inputs.forEach(i => i.value = '');
            },

            // --- PARSER INTERACTION ---
            clearParser: () => {
                document.getElementById('staged-container').style.display = 'none';
                document.getElementById('sms-input').value = '';
                document.getElementById('sms-input').disabled = false;
            },

            parseSMS: () => {
                const input = document.getElementById('sms-input');
                const text = input.value;
                
                if (!text.trim()) {
                    alert("Please paste an M-Pesa confirmation message first.");
                    return;
                }

                const parsed = Parser.parse(text);
                
                if (parsed.length === 0) {
                    alert("No valid M-Pesa transactions found in text.");
                    return;
                }

                const listContainer = document.getElementById('staged-list');
                listContainer.innerHTML = '';

                parsed.forEach((t, index) => {
                    // Auto-create member check
                    const existing = store.data.pledges.find(p => p.name.toLowerCase() === t.name.toLowerCase());
                    const isNew = !existing;
                    
                    if (!isNew) {
                        // Auto-register new member
                        store.addPledge(t.name, "Planning Committee", t.amount);
                    }

                    listContainer.innerHTML += `
                        <div class="flex-between" style="margin-bottom: 8px; padding: 12px; background: #F3F4F6; border-radius: 8px;">
                            <div>
                                <strong>${t.name}</strong>
                                <div style="font-size: 0.8rem; color: var(--text-sub);">
                                    ${t.type === 'M-Pesa' ? 'üì±' : 'üíµ'} ${t.type}
                                </div>
                                <div style="font-weight: 600; margin-top: 4px;">
                                    ${app.formatMoney(t.amount)}
                                </div>
                                <div style="font-family: monospace; font-size: 0.8rem; color: #666;">Ref: ${t.ref}</div>
                            </div>
                            <button class="btn btn-secondary btn-sm" onclick="document.getElementById('modal-ledger').close()">Skip</button>
                        </div>
                `;
                });

                // Update Stats
                document.getElementById('staged-count').innerText = parsed.length;
                document.getElementById('staged-container').style.display = 'block';
            },

            // --- THE FIX: SEQUENTIAL ADD ALL ---
            commitAll: async () => {
                const stagedList = document.getElementById('staged-list');
                const stagedRows = Array.from(stagedList.children);
                
                if (stagedRows.length === 0) return;

                // Show Spinner immediately
                UI.showSpinner(true, "Processing...");

                // Artificial delay to allow UI to update (Visual feedback)
                await new Promise(resolve => setTimeout(resolve, 50));

                const addedCount = { success: 0, duplicate: 0 };

                // Loop through items sequentially
                for (let i = 0; i < stagedRows.length; i++) {
                    const row = stagedRows[i];
                    const nameSpan = row.querySelector('strong').textContent;
                    const amtSpan = row.querySelector('.money').textContent; // Parsed amount
                    // Clean string to get number
                    const amount = parseFloat(amtSpan.textContent.replace(/[^0-9.-]+/g,?/g,?/g').replace(/[^0-9.,]+/g,?/g,?/g', ''));
                    
                    // Extract Ref
                    const ref = row.querySelector('.text-sub').textContent;

                    // Extract Type
                    const icon = row.querySelector('.icon').textContent;

                    const isNew = !store.data.pledges.find(p => p.name.toLowerCase() === nameSpan.toLowerCase().trim());
                    const isAmbiguous = row.querySelector('span').classList.contains('new-member');
                    
                    // Get department from parser (usually Till -> Planning)
                    // If ambiguous, select UI allows resolution
                    const deptSelect = row.querySelector('.resolve-dept-select');
                    let selectedDept = deptSelect ? deptSelect.value : "Planning Committee";

                    // Check duplicate
                    const duplicate = store.data.transactions.find(t => t.ref === ref);
                    if(duplicate) { 
                        alert(`Skipping duplicate ref: ${ref}`);
                        continue; // Skip this row but keep going
                    }

                    // Add Transaction
                    // AWAIT the store.save() to ensure database is updated
                    await store.addTransaction({
                        amount, 
                        name, ref, department: selectedDept, 
                        pledgeId: isNew ? store.data.pledges.find(p => p.name.toLowerCase() === nameSpan.toLowerCase()).id : null, 
                        type: icon === 'üì±' ? 'M-Pesa' : 'Cash'
                    });
                    
                    if(!duplicate) addedCount.success++;
                }

                app.clearParser();
                UI.showSpinner(false, "‚úÖ Done!");
                
                if (addedCount.success > 0) {
                    // Small delay to show "Done" state
                    setTimeout(() => alert(`‚úÖ Success! Added ${addedCount.success} transactions.`), 100);
                } else if (stagedRows.length > 0 && addedCount.duplicate === 0 && addedCount.success === 0) {
                    alert("No transactions were processed. They might be duplicates.");
                }
            },

            // --- RENDER LOGIC ---
            render: () => {
                // 1. Calculations
                const totalCash = store.data.transactions.reduce((sum, t) => sum + t.amount, 0);
                const totalExpenses = store.data.expenses.reduce((sum, e) => sum + e.amount, 0);
                const netBalance = totalCash - totalExpenses;
                const totalPledged = store.data.pledges.reduce((sum, p) => sum + p.amount, 0);

                // 2. Dashboard KPIs
                document.getElementById('dash-cash').textContent = app.formatMoney(totalCash);
                document.getElementById('dash-pledges').textContent = app.formatMoney(totalPledged);
                document.getElementById('dash-balance').textContent = app.formatMoney(netBalance);

                // 3. Phases
                const timelineDiv = document.getElementById('phase-timeline');
                timelineDiv.innerHTML = '';
                const today = new Date();
                let cumulativeTarget = 0;

                store.data.phases.forEach((phase) => {
                    cumulativeTarget += phase.totalTarget;
                    const pct = Math.min(100, (totalCash / cumulativeTarget) * 100).toFixed(1);
                    const isLate = new Date(phase.date) < today;
                    const statusClass = pct >= 100 ? 'completed' : (isLate && pct < 100) ? 'late' : 'active';
                    
                    timelineDiv.innerHTML += `
                        <div class="phase-item ${statusClass}">
                            <div class="phase-dot"></div>
                            <div style="margin-left: 20px;">
                                <div class="flex-between" style="margin-bottom: 8px;">
                                    <strong>${phase.name}</strong>
                                    <small>${new Date(phase.date).toLocaleDateString()}</small>
                                </div>
                                <div class="flex-between">
                                    <span class="text-sub">Target: ${app.formatMoney(cumulativeTarget)}</span>
                                    <span class="text-sub font-bold" style="font-size: 1.1rem;">${pct}%</span>
                                </div>
                                <div class="progress-track" style="height: 12px;">
                                    <div class="progress-fill" style="width: ${pct}%;"></div>
                                </div>
                            </div>
                        </div>
                    `;
                });

                // 4. Recent Activity (Mock)
                const recentList = document.getElementById('recent-activity-list');
                recentList.innerHTML = '';
                if (store.data.transactions.length > 0) {
                    store.data.transactions.slice(0, 5).forEach(t => {
                        recentList.innerHTML += `
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: white; border: 1px solid var(--border); border-radius: 8px;">
                                <div style="flex: 1;">
                                    <div style="font-weight: 600;">${t.name}</div>
                                    <small style="color: var(--text-sub); margin-top: 4px;">${t.type} ‚Ä¢ ${new Date(t.date).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</small>
                                </div>
                                <div style="font-weight: 700; color: var(--primary);">${app.formatMoney(t.amount)}</div>
                            </div>
                            <div>
                                <button class="btn btn-secondary btn-sm" onclick="app.viewReceipt('${t.ref}')">üìÑ Rec</button>
                            </div>
                        </div>`;
                    });
                } else {
                    recentList.innerHTML = '<p class="text-sub" style="text-align: center; padding: 40px;">No recent activity yet.</p>';
                }

                // 5. Leaderboard
                const lbContainer = document.getElementById('leaderboard-container');
                lbContainer.innerHTML = '';

                // Get stats per department
                const deptStats = DEPARTMENTS.map(dept => {
                    const deptCash = store.data.transactions
                        .filter(t => t.pledgeId && store.data.pledges.find(p => p.id === t.pledgeId && p.department === dept))
                        .reduce((sum, t) => sum + t.amount, 0);
                    
                    const phaseTarget = store.data.phases[store.data.phases.length - 1] ? store.data.phases[store.data.phases.length - 1].targets[dept] || 0;
                    const pct = phaseTarget ? Math.min(100, (deptCash / phaseTarget) * 100).toFixed(1) : 0;
                    
                    return { dept, deptCash, phaseTarget, pct };
                }).sort((a,b) => b.pct - a.pct);

                deptStats.forEach((stat, index) => {
                    const rank = index + 1;
                    lbContainer.innerHTML += `
                        <div class="stat-row">
                            <div style="width: 30px; height: 30px; border-radius: 50%; background: ${rank === 1 ? '#FFD700' : (rank === 2 ? '#C0C0C0' : (rank === 3 ? '#CD7F32' : '#999')};">
                                ${rank}
                            </div>
                            <div style="flex: 1;">
                                <div>
                                    <div style="font-weight: bold;">${stat.dept}</div>
                                    <small class="text-sub">Collected: ${app.formatMoney(stat.deptCash)} / ${app.formatMoney(stat.phaseTarget)}</small>
                                </div>
                                <div style="font-weight: bold; color: var(--primary);">${stat.pct}%</div>
                            </div>
                        </div>
                    `;
                });

                // 6. Phases List
                const phasesList = document.getElementById('phases-list');
                phasesList.innerHTML = '';
                store.data.phases.forEach(p => {
                    const pct = Math.min(100, (totalCash / p.totalTarget) * 100).toFixed(1);
                    const isLate = new Date(p.date) < new Date();
                    const late = pct < 100 && isLate;
                    
                    phasesList.innerHTML += `
                        <div class="stat-row">
                            <div style="font-size: 1.1rem; font-weight: 600;">${p.name}</div>
                            <div class="text-sub">${new Date(p.date).toLocaleDateString()} - ${app.formatMoney(p.totalTarget)}</div>
                            <div class="text-sub font-bold">${pct}%</div>
                            <button class="btn btn-danger btn-sm" onclick="store.deletePhase(${p.id})">Delete</button>
                        </div>
                    `;
                });
            },

            // 7. Ledger Table
            const ledgerBody = document.getElementById('ledger-body');
            ledgerBody.innerHTML = '';

            const ledgerRows = [
                ...store.data.transactions.map(t => ({...t, badgeClass: 'badge-success', category: 'Income', Type: 'M-Pesa' })),
                ...store.data.expenses.map(e => ({...e, badgeClass: 'badge-danger', category: 'Expense', Type: 'Expense' }))
            ].sort((a,b) => new Date(a.date) - new Date(b.date));

            ledgerRows.forEach(row => {
                const dateStr = new Date(row.date).toLocaleDateString() + ' ' + new Date(row.date).toLocaleTimeString([], {hour: '2-digit', minute: '2-digit' });
                ledgerBody.innerHTML += `
                    <tr>
                        <td style="color: var(--text-sub);">${dateStr}</td>
                        <td style="font-family: monospace;">${row.ref}</td>
                        <td>${row.name || row.description}</td>
                        <td class="money">${app.formatMoney(row.amount)}</td>
                        <td><span class="badge ${row.badgeClass}">${row.Type}</span></td>
                    </tr>
                `;
            }),

            exportCSV: (type) => {
                let csvContent = "data:text/csv;charset=utf-8,";
                
                if(type === 'ledger') {
                    csvContent += "Date,Reference,Name/Desc,Type,Amount\n";
                    ledgerRows.forEach(r => {
                        csvContent += `${new Date(r.date).toLocaleDateString()},${r.ref},"${r.name || r.description}","${r.Type}","${r.amount}\n`;
                    });
                } else {
                    csvContent += "Name,Department,Target,Redeemed,Balance\n";
                    store.data.pledges.forEach(p => {
                        csvContent += `"${p.name}","${p.department}",${p.amount},${p.redeemed},${p.amount - p.redeemed}\n`;
                    });
                }

                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", `dcd_land_${type}_${Date.now()}.csv`);
                document.body.appendChild(link);
                link.click();
            },

            viewReceipt: (ref) => {
                const tx = store.data.transactions.find(t => t.ref === ref);
                if(!tx) return;
                const msg = `RECEIPT\n---------\nDate: ${new Date(tx.date).toLocaleString()}\nName: ${tx.name}\nMethod: ${tx.type}\nAmount: KES ${tx.amount}\nRef: ${tx.ref}\n\nThank you for your contribution to DCD Possess The Land!`;
                alert(msg);
            }
        };

        // --- INIT ---
        app.init();
    </script>
</body>
</html><!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DCD Possess The Land | Fundraising</title>
    <style>
        /* --- CSS VARIABLES & RESET --- */
        :root {
            --primary: #059669;
            --primary-dark: #064E3B;
            --primary-light: #34D399;
            --secondary: #3B82F6;
            --accent: #F59E0B;
            --danger: #EF4444;
            --bg: #F3F4F6;
            --surface: #FFFFFF;
            --text-main: #111827;
            --text-sub: #6B7280;
            --border: #E5E7EB;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
        
        body { 
            background-color: var(--bg); 
            color: var(--text-main); 
            display: flex; 
            height: 100vh; 
            overflow: hidden;
        }

        /* --- LAYOUT --- */
        aside {
            width: 280px;
            background: #111827;
            color: white;
            display: flex;
            flex-direction: column;
            padding: 24px;
            z-index: 50;
            box-shadow: 2px 0 4px 6px rgba(0,0,0,0.15);
        }

        main { 
            flex: 1; 
            overflow-y: auto; 
            padding: 32px; 
            position: relative;
        }

        /* --- NAVIGATION --- */
        .brand { font-size: 1.2rem; font-weight: 800; margin-bottom: 40px; color: var(--primary); letter-spacing: 1px; display: flex; align-items: center; gap: 12px; }
        .nav-item { 
            padding: 14px; 
            margin-bottom: 8px; 
            border-radius: 8px; 
            cursor: pointer; 
            display: flex; 
            align-items: center; 
            gap: 12px; 
            color: #9CA3AF; 
            transition: all 0.2s; 
            font-size: 0.95rem;
        }
        .nav-item:hover { background: #374151; color: white; }
        .nav-item.active { background: var(--primary); color: white; font-weight: 600; }

        /* --- MOBILE RESPONSIVE --- */
        @media (max-width: 768px) {
            body { flex-direction: column; }
            aside { 
                width: 100%; 
                height: auto; 
                position: fixed; 
                bottom: 0; 
                left: 0; 
                flex-direction: row; 
                padding: 12px; 
                justify-content: space-around; 
                border-top: 1px solid var(--border); 
                background: white; 
                color: #333;
                box-shadow: 0 -2px 6px rgba(0,0,0,0.1);
                padding-bottom: 10px;
            }
            .brand { display: none; }
            .nav-item { flex-direction: column; gap: 4px; font-size: 0.75rem; text-align: center; padding: 8px; }
            main { padding-bottom: 80px; }
        }

        /* --- COMPONENTS --- */
        .card { 
            background: var(--surface); 
            padding: 24px; 
            border-radius: 12px; 
            border: 1px solid var(--border); 
            box-shadow: var(--shadow); 
            margin-bottom: 24px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .btn {
            padding: 12px 24px; 
            border-radius: 8px; 
            border: none; 
            cursor: pointer; 
            font-weight: 600;
            transition: all 0.2s ease; 
            display: inline-flex; 
            align-items: center; 
            gap: 8px; 
            justify-content: center;
        }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-dark); }
        .btn-primary:disabled { background: #9CA3AF; cursor: not-allowed; }
        .btn-secondary { background: white; border: 1px solid var(--border); color: var(--text-main); }
        .btn-secondary:hover { background: #f9fafb; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-sm { padding: 6px 12px; font-size: 0.85rem; }
        .btn-block { width: 100%; }

        input, select, textarea { 
            width: 100%; 
            padding: 14px; 
            border: 1px solid var(--border); 
            border-radius: 8px; 
            margin-bottom: 16px; 
            font-size: 1rem;
            transition: border-color 0.2s;
        }
        input:focus, select:focus, textarea:focus { 
            outline: 2px solid var(--primary); 
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(5, 150, 245, 0.1);
        }
        
        /* Progress Bars */
        .progress-track { 
            background: #E5E7EB; 
            height: 10px; 
            border-radius: 5px; 
            overflow: hidden; 
            margin-top: 8px; 
            position: relative;
        }
        .progress-fill { 
            height: 100%; 
            background: var(--primary); 
            width: 0%; 
            transition: width 0.5s ease; 
        }
        .progress-fill.amber { background: var(--accent); }
        .progress-fill.danger { background: var(--danger); }

        /* Tables */
        table { width: 100%; border-collapse: collapse; }
        th, td { 
            padding: 14px; 
            text-align: left; 
            border-bottom: 1px solid var(--border); 
            font-size: 0.9rem; 
        }
        th { background: #F9FAFB; color: var(--text-sub); font-weight: 600; text-transform: uppercase; font-size: 0.75rem; }
        tr:hover td { background: #fafafa; }
        .money { font-family: 'Courier New', monospace; font-weight: 600; color: var(--text-main); }
        .badge { padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 700; }
        .badge-success { background: var(--primary-light); color: var(--primary-dark); }
        .badge-warn { background: var(--accent); color: #92400E; }
        .badge-danger { background: #FEE2E2; color: var(--danger); }

        /* --- VIZUALS --- */
        .viz-grid { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 24px; 
        }

        .viz-card { 
            background: white; 
            padding: 24px; 
            border-radius: 12px; 
            border: 1px solid var(--border); 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
        }
        
        .donut-chart {
            width: 150px; height: 150px; 
            border-radius: 50%;
            background: conic-gradient(var(--primary) 0% 100%); 
            position: relative; 
            margin-bottom: 20px;
        }
        .donut-hole {
            width: 90px; height: 90px; 
            background: white; 
            border-radius: 50%;
            position: absolute; 
            top: 30px; left: 30px;
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center;
        }

        .stat-row {
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            font-size: 0.9rem; 
            margin-bottom: 10px;
        }

        /* --- TIMELINE --- */
        .phase-timeline { 
            border-left: 3px solid var(--border); 
            padding-left: 20px; 
            margin-left: 20px;
        }
        .phase-item { 
            position: relative; 
            margin-bottom: 40px; 
            padding-left: 20px; 
            border-left: 3px solid transparent; 
        }
        .phase-dot { 
            position: absolute; 
            left: -27px; 
            top: 5px; 
            width: 12px; 
            height: 12px; 
            border-radius: 50%; 
            background: var(--bg); 
            border: 3px solid var(--border);
        }
        .phase-item.active .phase-dot { border-color: var(--primary); background: var(--primary); }
        .phase-item.completed .phase-dot { border-color: var(--primary-dark); background: var(--primary-dark); }
        .phase-item.late .phase-dot { border-color: var(--danger); background: #FEE2E2; }

        /* --- MODAL --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); 
            display: none; 
            align-items: center; 
            justify-content: center; 
            z-index: 100;
            backdrop-filter: blur(4px);
        }
        .modal { 
            background: white; 
            width: 90%; 
            max-width: 550px; 
            padding: 32px; 
            border-radius: 16px; 
            box-shadow: 0 20px 25px rgba(0,0,0,0.15);
            animation: modalPop 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }
        @keyframes modalPop {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .form-grid-2 { grid-template-columns: 1fr 1fr; gap: 20px; }

        .loader {
            border: 3px solid var(--border);
            border-top: 3px solid transparent;
            border-radius: 50%;
            border-color: var(--primary);
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: none; /* Hidden by default */
            border-right-color: transparent;
            border-left-color: var(--primary);
            border-bottom: 3px solid transparent;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>

    <!-- SIDEBAR -->
    <aside>
        <div class="brand">üèù<br>DCD Possess<br>The Land</div>
        <div class="nav-group">
            <div class="nav-item active" onclick="app.navigate('dashboard')">üìä Dashboard</div>
            <div class="nav-item" onclick="app.navigate('leaderboard')">üèÜ Leaderboard</div>
            <div class="nav-item" onclick="app.navigate('pledges')">ü§ù Pledges</div>
            <div class="nav-item" onclick="app.navigate('ledger')">üí∞ Ledger</div>
            <div class="nav-item" onclick="app.navigate('tribes')">üè¢ Tribes</div>
            <div class="nav-item" onclick="app.navigate('settings')">‚öôÔ∏è Settings</div>
        </div>
    </aside>

    <!-- MAIN CONTENT -->
    <main>
        
        <!-- DASHBOARD VIEW -->
        <section id="view-dashboard">
            <header class="flex-between">
                <div>
                    <h1>Project Overview</h1>
                    <p class="text-sub">Real-time status for DCD Possess The Land</p>
                </div>
                <div style="display:flex; gap:12px;">
                    <button class="btn btn-danger" onclick="app.openModal('expense')">‚ûñ Expense</button>
                    <button class="btn btn-secondary" onclick="app.openModal('cash')">üíµ Add Cash</button>
                    <button class="btn btn-primary" onclick="app.openModal('pledge')">+ New Pledge</button>
                </div>
            </header>

            <!-- KPI CARDS -->
            <div class="viz-grid">
                <div class="viz-card">
                    <h4 style="color: var(--text-sub); margin-bottom: 10px;">Gross Cash</h4>
                    <div class="text-lg" id="dash-cash" style="color: var(--primary);">0</div>
                </div>
                <div class="viz-card">
                    <h4 style="color: var(--text-sub); margin-bottom: 10px;">Total Pledges</h4>
                    <div class="text-lg" id="dash-pledges">0</div>
                </div>
            </div>

            <!-- PHASE PROGRESS -->
            <div class="card">
                <div class="flex-between">
                    <h3>üìÖ Collection Phases</h3>
                    <button class="btn btn-secondary btn-sm" onclick="app.navigate('settings')">Edit Phases</button>
                </div>
                <div id="phase-timeline"></div>
            </div>

            <!-- RECENT ACTIVITY -->
            <div class="card">
                <h3>üî¥ Recent Activity</h3>
                <div id="recent-activity-list" style="display: flex; flex-direction: column; gap: 12px;">
                    <p class="text-sub" style="text-align: center;">No recent activity yet.</p>
                </div>
        </section>

        <!-- LEADERBOARD VIEW -->
        <section id="view-leaderboard" class="hidden">
            <h1>Department Leaderboard</h1>
            <div id="leaderboard-container" style="margin-top: 24px;">
                <!-- Populated by JS -->
            </div>
        </section>

        <!-- PLEDGES VIEW -->
        <section id="view-pledges" class="hidden">
            <div class="flex-between">
                <h1>Pledge Ledger</h1>
                <div style="display:flex; gap:12px;">
                    <button class="btn btn-secondary btn-sm" onclick="app.exportCSV('pledges')">üì• Export CSV</button>
                    <button class="btn btn-primary" onclick="app.openModal('pledge')">+ New Pledge</button>
                </div>
            </div>
            <div class="card" style="overflow: hidden; max-height: 60vh; overflow-y: auto;">
                <table style="width: 100%;">
                    <thead>
                        <tr>
                            <th>Member</th>
                            <th>Trial/Dept</th>
                            <th>Committed</th>
                            <th>Paid</th>
                            <th>Remaining</th>
                            <th>Status</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="pledges-body"></tbody>
                </table>
            </div>
        </section>

        <!-- LEDGER & RECONCILE VIEW -->
        <section id="view-ledger" class="hidden">
            <h1>Transaction Reconciliation</h1>
            
            <!-- PARSER UI -->
            <div class="card" style="border-left: 5px solid var(--primary);">
                <h3>ü§ñ M-Pesa SMS Parser</h3>
                <p class="text-sub" style="margin-bottom: 12px;">Paste your confirmation messages below.</p>
                
                <textarea 
                    id="sms-input" 
                    style="width: 100%; height: 120px; font-family: 'Courier New', monospace; font-size: 0.9rem;"
                    placeholder="Paste SMS here (e.g., 'You have received Ksh10,000 from John Doe...')..."
                ></textarea>
                
                <div style="display: flex; gap: 12px; margin-top: 16px;">
                    <button class="btn btn-secondary" onclick="app.clearParser()">Clear</button>
                    <button class="btn btn-primary" onclick="app.parseSMS()">‚ö° Extract</button>
                </div>

                <!-- Staged Area -->
                <div id="staged-container" style="display: none; margin-top: 20px; border-top: 1px solid var(--border); padding-top: 20px;">
                    <div class="flex-between">
                        <h4>Staged Transactions (<span id="staged-count">0</span>)</h4>
                        <button id="btn-add-all" class="btn btn-primary" onclick="app.commitAll()">‚úÖ Commit All</button>
                    </div>
                    <div class="loader" id="loading-spinner"></div>
                    <div id="staged-list" style="margin-top: 20px;"></div>
                </div>
            </div>

            <div class="flex-between" style="margin-top: 24px;">
                <h2>Audit Trail</h2>
                <button class="btn btn-secondary btn-sm" onclick="app.exportCSV('ledger')">üì• Export CSV</button>
            </div>

            <!-- ACTUAL LEDGER TABLE -->
            <div class="card" style="overflow: hidden; max-height: 50vh; overflow-y: auto;">
                <table style="width: 100%;">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Reference</th>
                            <th>Description</th>
                            <th>Amount</th>
                            <th>Type</th>
                        </tr>
                    </thead>
                    <tbody id="ledger-body"></tbody>
                </table>
            </div>
        </section>

        <!-- TRIBES VIEW -->
        <section id="view-tribes" class="hidden">
            <h1>Tribe Performance</h1>
            <div id="tribes-grid" class="viz-grid" style="margin-top: 24px;">
                <!-- Populated by JS -->
            </div>
        </section>

        <!-- SETTINGS VIEW -->
        <section id="view-settings" class="hidden">
            <h1>‚öôÔ∏è Admin</h1>
            
            <div class="card">
                <h3>Manage Collection Phases</h3>
                <p class="text-sub" style="margin-bottom: 12px;">Set deadlines and targets for your collection cycles.</p>
                
                <form onsubmit="app.addPhase(event)" class="form-grid-2">
                    <div>
                        <label style="font-weight: 600; color: var(--text-main);">Phase Name</label>
                        <input type="text" id="s-name" placeholder="e.g. March 8th Collection" required>
                    </div>
                    <div>
                        <label style="font-weight: 600; color: var(--text-main);">Target Date</label>
                        <input type="date" id="s-date" required>
                    </div>
                </form>

                <div style="margin-top: 20px; padding: 16px; background: #F9FAFB; border-radius: 8px;">
                    <strong>Current Phases:</strong>
                    <div id="phases-list"></div>
                </div>
            </div>

            <div class="card" style="border-color: var(--danger);">
                <h3 style="color: var(--danger);">Danger Zone</h3>
                <p class="text-sub">Reset entire project. This cannot be undone.</p>
                <button class="btn btn-danger" onclick="if(confirm('Are you sure?')) { store.reset(); location.reload(); }">Reset All Data</button>
            </div>
        </section>

    </main>

    <!-- MODAL: ADD PLEDGE -->
    <dialog id="modal-pledge">
        <form method="dialog">
            <h2 style="margin-bottom: 20px;">Add New Pledge</h2>
            
            <div class="form-grid">
                <div>
                    <label style="font-weight: 600; color: var(--text-main);">Member Name</label>
                    <input type="text" id="p-name" placeholder="John Doe" required autocomplete="off">
                </div>
                <div>
                    <label style="font-weight: 600; color: var(--text-main);">Department</label>
                    <select id="p-dept" required>
                        <option>Eagles</option>
                        <option>Daughters of Faith</option>
                        <option>Youth</option>
                        <option>Kingdom Generation</option>
                        <option>Planning Committee</option>
                    </select>
                </div>
            </div>

            <div style="margin-top: 20px; display: flex; justify-content: space-between;">
                <div class="form-grid-2">
                    <div>
                        <label style="font-weight: 600; color: var(--text-main);">Pledged Amount (KES)</label>
                        <input type="number" id="p-amount" min="0" placeholder="0.00" required>
                    </div>
                    <div style="display: flex; flex-direction: column; justify-content: center; gap: 8px;">
                        <small style="color: var(--text-sub);">* Auto-creates a member if not found.</small>
                    </div>
                </div>
            </div>

            <div style="display: flex; justify-content: flex-end; gap: 12px; margin-top: 20px;">
                <button class="btn btn-secondary" onclick="document.getElementById('modal-pledge').close()">Cancel</button>
                <button type="submit" class="btn btn-primary">Save Pledge</button>
            </div>
        </form>
    </dialog>

    <!-- MODAL: ADD CASH -->
    <dialog id="modal-cash">
        <form method="dialog">
            <h2 style="margin-bottom: 20px;">Record Cash Payment</h2>
            
            <div class="form-grid-2">
                <div>
                    <label style="font-weight: 600; color: var(--text-main);">Member Name</label>
                    <input type="text" id="c-name" placeholder="John Doe" required autocomplete="off">
                </div>
                <div>
                    <label style="font-style: normal; font-weight: 600; color: var(--text-main);">Amount (KES)</label>
                    <input type="number" id="c-amount" min="0" placeholder="0.00" required>
                </div>
            </div>

            <div style="display: flex; justify-content: flex-end; gap: 12px; margin-top: 20px;">
                <button class="btn btn-secondary" onclick="document.getElementById('modal-cash').close()">Cancel</button>
                <button type="submit" class="btn btn-primary">Record Payment</button>
            </div>
        </form>
    </dialog>

    <script>
        /**
         * Store: Manages LocalStorage and Data Logic
         */
        const DB_KEY = 'dcd_land_final_v13';

        const DEPARTMENTS = [
            "Eagles", 
            "Daughters of Faith", 
            "Youth", 
            "Kingdom Generation", 
            "Planning Committee"
        ];

        class Store {
            constructor() {
                const saved = localStorage.getItem(DB_KEY);
                this.data = saved ? JSON.parse(saved) : {
                    pledges: [],
                    transactions: [],
                    expenses: [],
                    phases: [
                        { 
                            id: 1, 
                            name: "March 8th Collection", 
                            date: "2024-03-08", 
                            totalTarget: 1000000,
                            targets: {
                                "Eagles": 200000,
                                "Daughters of Faith": 200000,
                                "Youth": 200000,
                                "Kingdom Generation": 200000,
                                "Planning Committee": 200000
                            }
                        }
                    ]
                };
            }

            save() {
                localStorage.setItem(DB_KEY, JSON.stringify(this.data));
                app.render();
            }

            addPledge(name, department, amount) {
                this.data.pledges.push({
                    id: Date.now(),
                    name, 
                    department, 
                    amount: Number(amount), 
                    redeemed: 0
                });
                this.save();
            }

            addTransaction(tx) {
                // 1. Find matching pledge
                let matchedPledge = null;
                // Use flexible matching to handle Josh vs Josh
                // Priority 1: Exact Name + Dept match (if dept provided)
                if (tx.department) {
                    matchedPledge = this.data.pledges.find(p => p.name.toLowerCase() === tx.name.toLowerCase() && p.department === tx.department);
                } 
                
                // Priority 2: Name match only (unique check)
                if (!matchedPledge) {
                    const allMatches = this.data.pledges.filter(p => p.name.toLowerCase() === tx.name.toLowerCase());
                    if (allMatches.length === 1) {
                        matchedPledge = allMatches[0];
                    }
                }

                if (matchedPledge) {
                    tx.name = matchedPledge.name; // Normalize name
                    tx.department = matchedPledge.department; // Normalize dept
                    tx.pledgeId = matchedPledge.id;
                    matchedPledge.redeemed = (matchedPledge.redeemed || 0) + tx.amount;
                } else {
                    tx.pledgeId = null;
                }

                this.data.transactions.unshift(tx);
                this.save();
            }

            addExpense(description, amount, category) {
                this.data.expenses.unshift({
                    id: Date.now(),
                    date: new Date().toISOString(),
                    description, amount: Number(amount), category
                });
                this.save();
            }

            addPhase(name, date, deptTargets) {
                // Validate non-negative
                for(let val of Object.values(deptTargets)) {
                    if(val < 0) { alert("Targets cannot be negative."); return; }
                }

                const total = Object.values(deptTargets).reduce((a,b) => a+b, 0);
                this.data.phases.push({
                    id: Date.now(),
                    name, date, totalTarget: total, targets: deptTargets
                });
                this.data.phases.sort((a,b) => new Date(a.date) - new Date(b.date));
                this.save();
            }

            deletePhase(id) {
                this.data.phases = this.data.phases.filter(p => p.id !== id);
                this.save();
            }

            reset() {
                localStorage.removeItem(DB_KEY);
                location.reload();
            }
        }

        const store = new Store();

        /**
         * UI Manager: Handles DOM manipulations and Event Listeners
         */
        const UI = {
            get: (id) => document.getElementById(id),
            
            showSection: (id) => {
                document.querySelectorAll('main section').forEach(el => el.classList.add('hidden'));
                const target = document.getElementById(`view-${id}`);
                if (target) target.classList.remove('hidden');
                
                // Update Nav
                document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
                // Try to find the nav item that triggered this (approximate based on structure)
                const navItems = document.querySelectorAll('.nav-item');
                navItems.forEach(el => {
                    // Check if this nav item contains text matching the view ID
                    if(el.textContent.toLowerCase().includes(id)) {
                        el.classList.add('active');
                    }
                });
            },

            showSpinner: (show, btnText) => {
                const btn = document.getElementById('btn-add-all');
                const loader = document.getElementById('loading-spinner');
                
                if (show) {
                    btn.disabled = true;
                    btn.innerText = "Processing...";
                    loader.style.display = 'inline-block';
                } else {
                    btn.disabled = false;
                    btn.innerText = "‚úÖ Commit All";
                    loader.style.display = 'none';
                }
            }
        };

        /**
         * Parser Logic: Robust M-Pesa Text Extraction
         */
        const Parser = {
            parse(text) {
                // 1. Regex Patterns
                // Matches "Received From" (Personal Account)
                // Matches "Sent To" (Till Number)
                
                const results = [];
                
                // Split by lines
                const lines = text.split('\n').filter(line => line.trim().length > 0);

                lines.forEach(line => {
                    let amount = null;
                    let name = "Unknown";
                    let ref = "N/A";
                    let type = "M-Pesa";

                    // 2. Attempt to parse "Received" format (Personal Account)
                    // Pattern: "You have received Ksh 10,000.00 from John Doe 0722..."
                    const receivedMatch = line.match(/You have received Ksh\s?([0-9,]+\.?\d*)\s+from\s+([A-Za-z\s]+?)(?:\s+(\d{10})/i);
                    
                    if (receivedMatch) {
                        amount = parseFloat(receivedMatch[1].replace(/,/g, '')); // Remove commas
                        name = receivedMatch[2] ? receivedMatch[2].trim() : "Unknown";
                        const phone = receivedMatch[3] || null; // Extract phone if available
                    } 
                    
                    // 3. Attempt to parse "Sent To" format (Till)
                    // Pattern: "Confirmed. Ksh 10,000.00 sent to LANDFUNDRAISER for account 567892..."
                    const sentMatch = line.match(/Ksh\s?([0-9,]+\.?\d*)\s+sent to\s+([A-Z\s]+)\s+for account\s+(\w+)/i);
                    
                    if (sentMatch) {
                        amount = parseFloat(sentMatch[1].replace(/,/g, ''));
                        name = "Till Transaction"; // Till payments usually don't have sender name in body
                        ref = sentMatch[3];
                        
                        // Extract Date if available
                        const dateMatch = line.match(/on\s+(\d{1,2}\/\d{2}\/\d{2})/i);
                        if(dateMatch) ref += ` (${dateMatch[1]})`;
                    }

                    if (amount) {
                        results.push({ amount, name, ref, phone, type });
                    }
                });

                return results;
            }
        };

        /**
         * App Logic: Controller
         */
        const app = {
            init: () => {
                app.render();
                // Add Listeners
                document.getElementById('btn-commit').addEventListener('click', app.commitAll);
                document.getElementById('sms-input').addEventListener('input', (e) => {
                    // Clear previous list on new input to allow re-parsing
                    app.clearParser();
                });
            },

            // --- Navigation ---
            navigate: (viewId) => {
                UI.showSection(viewId);
            },

            // --- Forms ---
            openModal: (modalId) => {
                const modal = document.getElementById(modalId);
                if(modal) {
                    modal.showModal();
                // Reset Form
                    const form = modal.querySelector('form');
                    if(form) form.reset();
                }
            },

            // --- Form Handling ---
            handlePledge: (e) => {
                e.preventDefault();
                const form = e.target;
                
                const name = form.querySelector('#p-name').value;
                const dept = form.querySelector('#p-dept').value;
                const amount = parseFloat(form.querySelector('#p-amount').value);
                
                if (!name || !amount) {
                    alert("Please fill in Name and Amount.");
                    return;
                }

                store.addPledge(name, dept, amount);
                document.getElementById('modal-pledge').close();
            },

            handleCash: (e) => {
                e.preventDefault();
                const form = e.target;
                
                const name = form.querySelector('#c-name').value;
                const amount = parseFloat(form.querySelector('#c-amount').value);
                const ref = 'CASH-' + Date.now();
                const dept = form.querySelector('#c-dept').value;

                if (!name || !amount) {
                    alert("Please fill in Name and Amount.");
                    return;
                }

                store.addTransaction({
                    amount, name, ref, department: dept, type: 'Cash'
                });
                document.getElementById('modal-cash').close();
            },

            handleExpense: (e) => {
                e.preventDefault();
                const form = e.target;
                const desc = form.querySelector('#e-desc').value;
                const amount = parseFloat(form.querySelector('#e-amount').value);
                const cat = form.querySelector('#e-cat').value;

                if(!desc || !amount) {
                    alert("Please fill in Description and Amount.");
                    return;
                }

                store.addExpense(desc, amount, cat);
                document.getElementById('modal-cash').close();
            },

            // --- Phases ---
            addPhase: (e) => {
                e.preventDefault();
                const form = e.target;
                
                const name = document.getElementById('s-name').value;
                const date = document.getElementById('s-date').value;
                
                const inputs = document.querySelectorAll('.target-input');
                const targets = {};
                inputs.forEach(i => { targets[i.dataset.dept] = Number(i.value) || 0; });

                store.addPhase(name, date, targets);
                document.getElementById('s-name').value = '';
                inputs.forEach(i => i.value = '');
            },

            // --- PARSER INTERACTION ---
            clearParser: () => {
                document.getElementById('staged-container').style.display = 'none';
                document.getElementById('sms-input').value = '';
                document.getElementById('sms-input').disabled = false;
            },

            parseSMS: () => {
                const input = document.getElementById('sms-input');
                const text = input.value;
                
                if (!text.trim()) {
                    alert("Please paste an M-Pesa confirmation message first.");
                    return;
                }

                const parsed = Parser.parse(text);
                
                if (parsed.length === 0) {
                    alert("No valid M-Pesa transactions found in text.");
                    return;
                }

                const listContainer = document.getElementById('staged-list');
                listContainer.innerHTML = '';

                parsed.forEach((t, index) => {
                    // Auto-create member check
                    const existing = store.data.pledges.find(p => p.name.toLowerCase() === t.name.toLowerCase());
                    const isNew = !existing;
                    
                    if (!isNew) {
                        // Auto-register new member
                        store.addPledge(t.name, "Planning Committee", t.amount);
                    }

                    listContainer.innerHTML += `
                        <div class="flex-between" style="margin-bottom: 8px; padding: 12px; background: #F3F4F6; border-radius: 8px;">
                            <div>
                                <strong>${t.name}</strong>
                                <div style="font-size: 0.8rem; color: var(--text-sub);">
                                    ${t.type === 'M-Pesa' ? 'üì±' : 'üíµ'} ${t.type}
                                </div>
                                <div style="font-weight: 600; margin-top: 4px;">
                                    ${app.formatMoney(t.amount)}
                                </div>
                                <div style="font-family: monospace; font-size: 0.8rem; color: #666;">Ref: ${t.ref}</div>
                            </div>
                            <button class="btn btn-secondary btn-sm" onclick="document.getElementById('modal-ledger').close()">Skip</button>
                        </div>
                `;
                });

                // Update Stats
                document.getElementById('staged-count').innerText = parsed.length;
                document.getElementById('staged-container').style.display = 'block';
            },

            // --- THE FIX: SEQUENTIAL ADD ALL ---
            commitAll: async () => {
                const stagedList = document.getElementById('staged-list');
                const stagedRows = Array.from(stagedList.children);
                
                if (stagedRows.length === 0) return;

                // Show Spinner immediately
                UI.showSpinner(true, "Processing...");

                // Artificial delay to allow UI to update (Visual feedback)
                await new Promise(resolve => setTimeout(resolve, 50));

                const addedCount = { success: 0, duplicate: 0 };

                // Loop through items sequentially
                for (let i = 0; i < stagedRows.length; i++) {
                    const row = stagedRows[i];
                    const nameSpan = row.querySelector('strong').textContent;
                    const amtSpan = row.querySelector('.money').textContent; // Parsed amount
                    // Clean string to get number
                    const amount = parseFloat(amtSpan.textContent.replace(/[^0-9.-]+/g,?/g,?/g').replace(/[^0-9.,]+/g,?/g,?/g', ''));
                    
                    // Extract Ref
                    const ref = row.querySelector('.text-sub').textContent;

                    // Extract Type
                    const icon = row.querySelector('.icon').textContent;

                    const isNew = !store.data.pledges.find(p => p.name.toLowerCase() === nameSpan.toLowerCase().trim());
                    const isAmbiguous = row.querySelector('span').classList.contains('new-member');
                    
                    // Get department from parser (usually Till -> Planning)
                    // If ambiguous, select UI allows resolution
                    const deptSelect = row.querySelector('.resolve-dept-select');
                    let selectedDept = deptSelect ? deptSelect.value : "Planning Committee";

                    // Check duplicate
                    const duplicate = store.data.transactions.find(t => t.ref === ref);
                    if(duplicate) { 
                        alert(`Skipping duplicate ref: ${ref}`);
                        continue; // Skip this row but keep going
                    }

                    // Add Transaction
                    // AWAIT the store.save() to ensure database is updated
                    await store.addTransaction({
                        amount, 
                        name, ref, department: selectedDept, 
                        pledgeId: isNew ? store.data.pledges.find(p => p.name.toLowerCase() === nameSpan.toLowerCase()).id : null, 
                        type: icon === 'üì±' ? 'M-Pesa' : 'Cash'
                    });
                    
                    if(!duplicate) addedCount.success++;
                }

                app.clearParser();
                UI.showSpinner(false, "‚úÖ Done!");
                
                if (addedCount.success > 0) {
                    // Small delay to show "Done" state
                    setTimeout(() => alert(`‚úÖ Success! Added ${addedCount.success} transactions.`), 100);
                } else if (stagedRows.length > 0 && addedCount.duplicate === 0 && addedCount.success === 0) {
                    alert("No transactions were processed. They might be duplicates.");
                }
            },

            // --- RENDER LOGIC ---
            render: () => {
                // 1. Calculations
                const totalCash = store.data.transactions.reduce((sum, t) => sum + t.amount, 0);
                const totalExpenses = store.data.expenses.reduce((sum, e) => sum + e.amount, 0);
                const netBalance = totalCash - totalExpenses;
                const totalPledged = store.data.pledges.reduce((sum, p) => sum + p.amount, 0);

                // 2. Dashboard KPIs
                document.getElementById('dash-cash').textContent = app.formatMoney(totalCash);
                document.getElementById('dash-pledges').textContent = app.formatMoney(totalPledged);
                document.getElementById('dash-balance').textContent = app.formatMoney(netBalance);

                // 3. Phases
                const timelineDiv = document.getElementById('phase-timeline');
                timelineDiv.innerHTML = '';
                const today = new Date();
                let cumulativeTarget = 0;

                store.data.phases.forEach((phase) => {
                    cumulativeTarget += phase.totalTarget;
                    const pct = Math.min(100, (totalCash / cumulativeTarget) * 100).toFixed(1);
                    const isLate = new Date(phase.date) < today;
                    const statusClass = pct >= 100 ? 'completed' : (isLate && pct < 100) ? 'late' : 'active';
                    
                    timelineDiv.innerHTML += `
                        <div class="phase-item ${statusClass}">
                            <div class="phase-dot"></div>
                            <div style="margin-left: 20px;">
                                <div class="flex-between" style="margin-bottom: 8px;">
                                    <strong>${phase.name}</strong>
                                    <small>${new Date(phase.date).toLocaleDateString()}</small>
                                </div>
                                <div class="flex-between">
                                    <span class="text-sub">Target: ${app.formatMoney(cumulativeTarget)}</span>
                                    <span class="text-sub font-bold" style="font-size: 1.1rem;">${pct}%</span>
                                </div>
                                <div class="progress-track" style="height: 12px;">
                                    <div class="progress-fill" style="width: ${pct}%;"></div>
                                </div>
                            </div>
                        </div>
                    `;
                });

                // 4. Recent Activity (Mock)
                const recentList = document.getElementById('recent-activity-list');
                recentList.innerHTML = '';
                if (store.data.transactions.length > 0) {
                    store.data.transactions.slice(0, 5).forEach(t => {
                        recentList.innerHTML += `
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: white; border: 1px solid var(--border); border-radius: 8px;">
                                <div style="flex: 1;">
                                    <div style="font-weight: 600;">${t.name}</div>
                                    <small style="color: var(--text-sub); margin-top: 4px;">${t.type} ‚Ä¢ ${new Date(t.date).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</small>
                                </div>
                                <div style="font-weight: 700; color: var(--primary);">${app.formatMoney(t.amount)}</div>
                            </div>
                            <div>
                                <button class="btn btn-secondary btn-sm" onclick="app.viewReceipt('${t.ref}')">üìÑ Rec</button>
                            </div>
                        </div>`;
                    });
                } else {
                    recentList.innerHTML = '<p class="text-sub" style="text-align: center; padding: 40px;">No recent activity yet.</p>';
                }

                // 5. Leaderboard
                const lbContainer = document.getElementById('leaderboard-container');
                lbContainer.innerHTML = '';

                // Get stats per department
                const deptStats = DEPARTMENTS.map(dept => {
                    const deptCash = store.data.transactions
                        .filter(t => t.pledgeId && store.data.pledges.find(p => p.id === t.pledgeId && p.department === dept))
                        .reduce((sum, t) => sum + t.amount, 0);
                    
                    const phaseTarget = store.data.phases[store.data.phases.length - 1] ? store.data.phases[store.data.phases.length - 1].targets[dept] || 0;
                    const pct = phaseTarget ? Math.min(100, (deptCash / phaseTarget) * 100).toFixed(1) : 0;
                    
                    return { dept, deptCash, phaseTarget, pct };
                }).sort((a,b) => b.pct - a.pct);

                deptStats.forEach((stat, index) => {
                    const rank = index + 1;
                    lbContainer.innerHTML += `
                        <div class="stat-row">
                            <div style="width: 30px; height: 30px; border-radius: 50%; background: ${rank === 1 ? '#FFD700' : (rank === 2 ? '#C0C0C0' : (rank === 3 ? '#CD7F32' : '#999')};">
                                ${rank}
                            </div>
                            <div style="flex: 1;">
                                <div>
                                    <div style="font-weight: bold;">${stat.dept}</div>
                                    <small class="text-sub">Collected: ${app.formatMoney(stat.deptCash)} / ${app.formatMoney(stat.phaseTarget)}</small>
                                </div>
                                <div style="font-weight: bold; color: var(--primary);">${stat.pct}%</div>
                            </div>
                        </div>
                    `;
                });

                // 6. Phases List
                const phasesList = document.getElementById('phases-list');
                phasesList.innerHTML = '';
                store.data.phases.forEach(p => {
                    const pct = Math.min(100, (totalCash / p.totalTarget) * 100).toFixed(1);
                    const isLate = new Date(p.date) < new Date();
                    const late = pct < 100 && isLate;
                    
                    phasesList.innerHTML += `
                        <div class="stat-row">
                            <div style="font-size: 1.1rem; font-weight: 600;">${p.name}</div>
                            <div class="text-sub">${new Date(p.date).toLocaleDateString()} - ${app.formatMoney(p.totalTarget)}</div>
                            <div class="text-sub font-bold">${pct}%</div>
                            <button class="btn btn-danger btn-sm" onclick="store.deletePhase(${p.id})">Delete</button>
                        </div>
                    `;
                });
            },

            // 7. Ledger Table
            const ledgerBody = document.getElementById('ledger-body');
            ledgerBody.innerHTML = '';

            const ledgerRows = [
                ...store.data.transactions.map(t => ({...t, badgeClass: 'badge-success', category: 'Income', Type: 'M-Pesa' })),
                ...store.data.expenses.map(e => ({...e, badgeClass: 'badge-danger', category: 'Expense', Type: 'Expense' }))
            ].sort((a,b) => new Date(a.date) - new Date(b.date));

            ledgerRows.forEach(row => {
                const dateStr = new Date(row.date).toLocaleDateString() + ' ' + new Date(row.date).toLocaleTimeString([], {hour: '2-digit', minute: '2-digit' });
                ledgerBody.innerHTML += `
                    <tr>
                        <td style="color: var(--text-sub);">${dateStr}</td>
                        <td style="font-family: monospace;">${row.ref}</td>
                        <td>${row.name || row.description}</td>
                        <td class="money">${app.formatMoney(row.amount)}</td>
                        <td><span class="badge ${row.badgeClass}">${row.Type}</span></td>
                    </tr>
                `;
            }),

            exportCSV: (type) => {
                let csvContent = "data:text/csv;charset=utf-8,";
                
                if(type === 'ledger') {
                    csvContent += "Date,Reference,Name/Desc,Type,Amount\n";
                    ledgerRows.forEach(r => {
                        csvContent += `${new Date(r.date).toLocaleDateString()},${r.ref},"${r.name || r.description}","${r.Type}","${r.amount}\n`;
                    });
                } else {
                    csvContent += "Name,Department,Target,Redeemed,Balance\n";
                    store.data.pledges.forEach(p => {
                        csvContent += `"${p.name}","${p.department}",${p.amount},${p.redeemed},${p.amount - p.redeemed}\n`;
                    });
                }

                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", `dcd_land_${type}_${Date.now()}.csv`);
                document.body.appendChild(link);
                link.click();
            },

            viewReceipt: (ref) => {
                const tx = store.data.transactions.find(t => t.ref === ref);
                if(!tx) return;
                const msg = `RECEIPT\n---------\nDate: ${new Date(tx.date).toLocaleString()}\nName: ${tx.name}\nMethod: ${tx.type}\nAmount: KES ${tx.amount}\nRef: ${tx.ref}\n\nThank you for your contribution to DCD Possess The Land!`;
                alert(msg);
            }
        };

        // --- INIT ---
        app.init();
    </script>
</body>
</html>
