<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DCD Possess The Land | Fundraising</title>
    <style>
        /* --- 1. CSS VARIABLES --- */
        :root {
            /* Palette */
            --primary: #059669; /* Emerald Green */
            --primary-dark: #064E3B;
            --primary-light: #D1FAE5;
            --secondary: #3B82F6; /* Blue */
            --accent: #F59E0B; /* Amber */
            --danger: #EF4444;
            --bg: #F3F4F6;
            --surface: #FFFFFF;
            --text-main: #1F2937;
            --text-sub: #6B7280;
            --border: #E5E7EB;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        /* --- 2. GLOBAL RESET --- */
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        
        body { 
            background-color: var(--bg); 
            color: var(--text-main); 
            display: flex; 
            height: 100vh; 
            overflow: hidden; 
        }

        /* --- 3. LAYOUT --- */
        aside {
            width: 280px;
            background: #111827;
            color: white;
            display: flex;
            flex-direction: column;
            padding: 24px;
            z-index: 50;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
        }

        main { 
            flex: 1; 
            overflow-y: auto; 
            padding: 32px; 
            position: relative;
        }

        /* --- 4. NAVIGATION --- */
        .brand { 
            font-size: 1.2rem; 
            font-weight: 800; 
            margin-bottom: 48px; 
            color: var(--primary); 
            letter-spacing: 1px; 
            display: flex; 
            align-items: center; 
            gap: 12px; 
            line-height: 1;
        }

        .nav-group { display: flex; flex-direction: column; gap: 8px; }

        .nav-item { 
            padding: 14px; 
            margin-bottom: 4px; 
            border-radius: 8px; 
            cursor: pointer;
            display: flex; 
            align-items: center; 
            gap: 12px; 
            color: #9CA3AF; 
            transition: all 0.2s ease; 
            font-size: 0.95rem;
            border: 1px solid transparent;
        }

        .nav-item:hover { 
            background: #374151; 
            color: white; 
            border-color: #374151;
        }

        .nav-item.active { 
            background: var(--primary); 
            color: white; 
            font-weight: 600;
        }

        /* --- 5. MOBILE RESPONSIVENESS --- */
        @media (max-width: 768px) {
            body { flex-direction: column; }
            aside { 
                width: 100%; 
                height: auto; 
                position: fixed; 
                bottom: 0; 
                left: 0; 
                flex-direction: row; 
                padding: 12px; 
                justify-content: space-around; 
                border-top: 1px solid var(--border); 
                background: white; 
                color: #333;
                box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            }
            .brand { display: none; }
            .nav-item { 
                flex-direction: column; 
                gap: 4px; 
                font-size: 0.75rem; 
                text-align: center; 
                padding: 8px;
                background: transparent;
            }
            .nav-item:hover { background: rgba(0,0,0,0.05); }
            main { padding-bottom: 70px; } /* Space for bottom nav */
        }

        /* --- 6. COMPONENTS --- */
        .card { 
            background: var(--surface); 
            padding: 24px; 
            border-radius: 12px; 
            border: 1px solid var(--border); 
            box-shadow: var(--shadow); 
            margin-bottom: 24px;
        }

        .btn { 
            padding: 12px 24px; 
            border-radius: 8px; 
            border: none; 
            cursor: pointer; 
            font-weight: 600;
            transition: all 0.2s ease; 
            display: inline-flex; 
            align-items: center; 
            gap: 8px; 
            justify-content: center;
            font-size: 0.95rem;
        }
        
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-dark); }
        .btn-primary:disabled { background: #9CA3AF; cursor: not-allowed; opacity: 0.7; }
        .btn-secondary { background: white; border: 1px solid var(--border); color: var(--text-main); }
        .btn-secondary:hover { background: #f9fafb; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-sm { padding: 8px 16px; font-size: 0.85rem; }
        .btn-block { width: 100%; }

        input, select, textarea { 
            width: 100%; 
            padding: 12px; 
            border: 1px solid var(--border); 
            border-radius: 8px; 
            margin-bottom: 16px;
            font-size: 1rem;
            transition: border-color 0.2s;
        }
        input:focus, select:focus, textarea:focus { 
            outline: 2px solid var(--primary); 
            border-color: var(--primary); 
            box-shadow: 0 0 0 3px rgba(5, 150, 245, 0.1);
        }
        
        .checkbox-wrapper { display: flex; align-items: center; gap: 10px; margin-bottom: 16px; cursor: pointer; }
        .checkbox-wrapper input { width: auto; margin: 0; cursor: pointer; }

        /* --- 7. VISUALS --- */
        .text-lg { font-size: 1.5rem; font-weight: 700; }
        .text-xl { font-size: 2.25rem; font-weight: 800; color: var(--primary-dark); }
        .text-sub { color: var(--text-sub); font-size: 0.9rem; }
        .badge { padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 700; }
        .badge-success { background: var(--primary-light); color: var(--primary-dark); }
        .badge-warn { background: var(--accent); color: #92400E; }
        .badge-danger { background: #FEE2E2; color: var(--danger); }

        .progress-track { background: #E5E7EB; height: 12px; border-radius: 6px; overflow: hidden; margin-top: 8px; position: relative; }
        .progress-fill { height: 100%; background: var(--primary); width: 0%; transition: width 0.6s ease-out; }
        .progress-fill.amber { background: var(--accent); }
        .progress-fill.danger { background: var(--danger); }

        /* --- 8. TABLES --- */
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 14px; text-align: left; border-bottom: 1px solid var(--border); font-size: 0.9rem; }
        th { background: #F9FAFB; color: var(--text-sub); font-weight: 600; text-transform: uppercase; font-size: 0.75rem; }
        tr:hover td { background: #fafafa; }
        
        .money { font-family: 'Courier New', monospace; font-weight: 600; color: var(--text-main); }

        /* --- 9. VIZUALIZATION COMPONENTS --- */
        .viz-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 24px; }
        .viz-card { 
            background: white; 
            padding: 24px; 
            border-radius: 12px; 
            border: 1px solid var(--border); 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center;
        }
        
        .donut-chart {
            width: 160px; height: 160px; 
            border-radius: 50%;
            background: conic-gradient(var(--primary) 0% 100%); 
            position: relative; 
            margin-bottom: 20px;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.05);
        }
        .donut-hole {
            width: 100px; height: 100px; 
            background: white; 
            border-radius: 50%;
            position: absolute; top: 30px; left: 30px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }

        /* --- 10. MODAL --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 100;
            backdrop-filter: blur(2px);
        }
        .modal { 
            background: white; 
            width: 90%; 
            max-width: 500px; 
            padding: 32px; 
            border-radius: 16px; 
            box-shadow: 0 20px 25px rgba(0,0,0,0.15);
            animation: modalSlide 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }

        @keyframes modalSlide {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px; }
        .form-group { margin-bottom: 16px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-main); }
        
        /* --- 11. HELPER CLASSES --- */
        .hidden { display: none !important; }
        .flex-between { display: flex; justify-content: space-between; align-items: center; }
        .text-right { text-align: right; }
        .mt-2 { margin-top: 16px; }

    </style>
</head>
<body>

    <!-- SIDEBAR -->
    <aside>
        <div class="brand">
            <div style="width: 32px; height: 32px; background: var(--primary); border-radius: 8px; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 1.2rem;">üåç</div>
            DCD Possess The Land
        </div>
        <div class="nav-group">
            <div class="nav-item active" onclick="app.navigate('dashboard')">üìä Dashboard</div>
            <div class="nav-item" onclick="app.navigate('leaderboard')">üèÜ Leaderboard</div>
            <div class="nav-item" onclick="app.navigate('pledges')">ü§ù Pledges</div>
            <div class="nav-item" onclick="app.navigate('ledger')">üí∞ Ledger</div>
            <div class="nav-item" onclick="app.navigate('tribes')">üè¢ Tribes</div>
            <div class="nav-item" onclick="app.navigate('settings')">‚öôÔ∏è Settings</div>
        </div>
    </aside>

    <!-- MAIN CONTENT -->
    <main>
        
        <!-- DASHBOARD VIEW -->
        <section id="view-dashboard">
            <header class="flex-between">
                <div>
                    <h1>Project Overview</h1>
                    <p class="text-sub">Real-time status for DCD Possess The Land</p>
                </div>
                <div style="display: flex; gap: 12px;">
                    <button class="btn btn-danger" onclick="app.openModal('expense')">‚ûñ Expense</button>
                    <button class="btn btn-secondary" onclick="app.openModal('cash')">üíµ Add Cash</button>
                    <button class="btn btn-primary" onclick="app.openModal('pledge')">+ New Pledge</button>
                </div>
            </header>

            <!-- KPI CARDS -->
            <div class="viz-grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));">
                <div class="viz-card">
                    <div class="text-sub">Gross Cash Collected</div>
                    <div class="text-xl" id="dash-cash">0</div>
                </div>
                <div class="viz-card">
                    <div class="text-sub">Net Balance</div>
                    <div class="text-xl" id="dash-balance" style="color: var(--primary-dark);">0</div>
                </div>
                <div class="viz-card">
                    <div class="text-sub">Total Pledges</div>
                    <div class="text-xl" id="dash-pledges">0</div>
                </div>
            </div>

            <!-- PHASES -->
            <div class="card mt-2">
                <div class="flex-between" style="margin-bottom: 12px;">
                    <h3 style="color: var(--text-main);">Collection Phases</h3>
                    <button class="btn btn-secondary btn-sm" onclick="app.navigate('settings')">Edit Phases</button>
                </div>
                
                <div id="phase-timeline-container">
                    <!-- Populated by JS -->
                </div>
            </div>

            <!-- RECENT ACTIVITY -->
            <div class="card">
                <div class="flex-between" style="margin-bottom: 12px;">
                    <h3 style="color: var(--text-main);">Recent Activity</h3>
                </div>
                <div id="recent-activity-list" style="display: flex; flex-direction: column; gap: 12px;">
                    <p class="text-sub" style="text-align: center; padding: 20px;">No recent activity yet.</p>
                </div>
            </div>
        </section>

        <!-- LEADERBOARD VIEW -->
        <section id="view-leaderboard" class="hidden">
            <div class="flex-between">
                <h1>Department Leaderboard</h1>
                <div style="display: flex; gap: 12px;">
                    <button class="btn btn-secondary btn-sm" onclick="app.exportCSV('pledges')">üì• Export</button>
                </div>
            </div>
            <p class="text-sub" style="margin-bottom: 24px;">Performance ranked by current phase completion.</p>
            
            <div class="card">
                <table style="width: 100%;">
                    <thead>
                        <tr>
                            <th style="text-align: left;">Rank</th>
                            <th>Department</th>
                            <th style="text-align: right;">Target</th>
                            <th style="text-align: right;">Collected</th>
                            <th style="text-align: center;">Progress</th>
                        </tr>
                    </thead>
                    <tbody id="leaderboard-body">
                        <!-- Populated by JS -->
                    </tbody>
                </table>
            </div>
        </section>

        <!-- PLEDGES VIEW -->
        <section id="view-pledges" class="hidden">
            <div class="flex-between">
                <h1>Pledges & Members</h1>
                <div style="display: flex; gap: 12px;">
                    <button class="btn btn-secondary btn-sm" onclick="app.exportCSV('pledges')">üì• Export CSV</button>
                    <button class="btn btn-primary" onclick="app.openModal('pledge')">+ New Pledge</button>
                </div>
            </div>
            <div class="card mt-2">
                <table style="width: 100%;">
                    <thead>
                        <tr>
                            <th>Member</th>
                            <th>Tribe</th>
                            <th style="text-align: right;">Pledged</th>
                            <th style="text-align: right;">Redeemed</th>
                            <th style="text-align: right;">Remaining</th>
                            <th style="text-align: center;">Action</th>
                        </tr>
                    </thead>
                    <tbody id="pledges-body">
                        <!-- Populated by JS -->
                    </tbody>
                </table>
            </div>
        </section>

        <!-- LEDGER VIEW -->
        <section id="view-ledger" class="hidden">
            <div class="flex-between">
                <h1>Transaction Ledger</h1>
                <button class="btn btn-secondary btn-sm" onclick="app.exportCSV('ledger')">üì• Export</button>
            </div>

            <!-- PARSER -->
            <div class="card" style="border-left: 4px solid var(--primary); background: #F0FDF4;">
                <div class="flex-between">
                    <h3>ü§ñ M-Pesa SMS Parser</h3>
                    <span class="badge badge-success" style="margin-left: 8px;">Integrated</span>
                </div>
            </div>

            <div class="card mt-2" style="background: white;">
                <div class="form-group">
                    <label style="font-weight: 600; color: var(--text-sub); display: block; margin-bottom: 8px;">Paste M-Pesa Messages</label>
                    <textarea id="sms-input" style="min-height: 150px; font-family: 'Courier New', monospace; font-size: 0.9rem;" placeholder="Paste SMS messages here (e.g., 'Ksh10,000 received from John Doe...')..."></textarea>
                </div>
                <div class="flex-between">
                    <button class="btn btn-secondary" onclick="app.clearParser()">Clear</button>
                    <button class="btn btn-primary" onclick="app.parseSMS()">‚ö° Extract Transactions</button>
                </div>

                <!-- Stats Area -->
                <div id="parser-stats" style="display: none; margin-top: 24px; padding: 16px; background: var(--bg); border-radius: 8px;">
                    <div class="viz-grid" style="grid-template-columns: repeat(4, 1fr);">
                        <div class="viz-card" style="padding: 16px;">
                            <div class="text-sub">Total Parsed</div>
                            <div class="text-lg" id="st-total">0</div>
                        </div>
                        <div class="viz-card" style="padding: 16px;">
                            <div class="text-sub">New Members</div>
                            <div class="text-lg" id="st-new" style="color: var(--secondary);">0</div>
                        </div>
                        <div class="viz-card" style="padding: 16px;">
                            <div class="text-sub">Matched</div>
                            <div class="text-lg" id="st-matched" style="color: var(--primary);">0</div>
                        </div>
                        <div class="viz-card" style="padding: 16px;">
                            <div class="text-sub">Unmatched</div>
                            <div class="text-lg" id="st-unmatched" style="color: var(--accent);">0</div>
                        </div>
                    </div>
                </div>

                <div id="staged-container" style="display: none; margin-top: 24px;">
                    <div class="flex-between" style="margin-bottom: 16px;">
                        <h4 style="color: var(--text-main);">Staged Transactions (<span id="staged-count">0</span>)</h4>
                        <div style="display: flex; gap: 12px;">
                            <button class="btn btn-secondary" onclick="app.clearParser()">Clear All</button>
                            <button id="btn-commit-all" class="btn btn-primary" onclick="app.commitAll()">‚úÖ Commit All</button>
                        </div>
                    </div>
                    <div id="staged-list" style="display: flex; flex-direction: column; gap: 12px; margin-top: 16px;">
                        <!-- Populated by JS -->
                    </div>
                </div>
            </div>

            <!-- ACTUAL LEDGER -->
            <div class="card mt-4">
                <table style="width: 100%;">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Reference</th>
                            <th>Member</th>
                            <th style="text-align: right;">Amount</th>
                            <th>Type</th>
                            <th>Linked Pledge</th>
                        </tr>
                    </thead>
                    <tbody id="ledger-body">
                        <!-- Populated by JS -->
                    </tbody>
                </table>
            </div>
        </section>

        <!-- TRIBES VIEW -->
        <section id="view-tribes" class="hidden">
            <h1>Tribe Performance</h1>
            <p class="text-sub">Comparison of Cash Collected vs Active Phase Targets.</p>
            <div id="tribes-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 24px; margin-top: 24px;">
                <!-- Populated by JS -->
            </div>
        </section>

        <!-- SETTINGS VIEW -->
        <section id="view-settings" class="hidden">
            <h1>‚öôÔ∏è Settings</h1>
            <div class="card">
                <div class="flex-between" style="margin-bottom: 16px;">
                    <h3>Collection Phases</h3>
                    <button class="btn btn-danger btn-sm" onclick="app.resetData()">Reset All Data</button>
                </div>
                
                <div id="phases-list" style="display: flex; flex-direction: column; gap: 12px;">
                    <!-- Populated by JS -->
                </div>

                <button class="btn btn-primary mt-2" style="width: 100%;">+ Add New Phase</button>
            </div>
        </section>

    </main>

    <!-- MODALS -->
    <!-- Add Pledge Modal -->
    <dialog class="modal" id="modal-pledge">
        <form method="dialog">
            <h2 style="margin-bottom: 24px;">Add New Pledge</h2>
            
            <div class="form-grid">
                <div class="form-group">
                    <label>Member Name</label>
                    <input type="text" id="p-name" placeholder="John Doe" required autocomplete="off">
                </div>
                <div class="form-group">
                    <label>Phone Number</label>
                    <input type="tel" id="p-phone" placeholder="07..." autocomplete="tel">
                </div>
            </div>
            
            <div class="form-group">
                <label>Trial/Department</label>
                <select id="p-dept" required>
                    <option>Eagles</option>
                    <option>Daughters of Faith</option>
                    <option>Youth</option>
                    <option>Kingdom Generation</option>
                    <option>Planning Committee</option>
                </select>
            </div>

            <div class="form-group">
                <label>Pledged Amount (KES)</label>
                <input type="number" id="p-amount" min="0" placeholder="0.00" required>
            </div>

            <div class="flex-between mt-2">
                <button type="button" class="btn btn-secondary" onclick="app.closeModal('pledge')">Cancel</button>
                <button type="submit" class="btn btn-primary">Save Pledge</button>
            </div>
        </form>
    </dialog>

    <!-- Add Cash Modal -->
    <dialog class="modal" id="modal-cash">
        <form method="dialog">
            <h2 style="margin-bottom: 24px;">Record Cash Payment</h2>
            
            <div class="form-group">
                <label>Member Name</label>
                <input type="text" id="c-name" placeholder="John Doe" required>
            </div>

            <div class="form-grid">
                <div class="form-group">
                    <label>Amount (KES)</label>
                    <input type="number" id="c-amount" min="0" placeholder="0.00" required>
                </div>
                <div class="form-group">
                    <label>Reference # (Optional)</label>
                    <input type="text" id="c-ref" placeholder="RCPT-001">
                </div>
            </div>

            <div class="form-group">
                <label>Trial/Department</label>
                <select id="c-dept" required>
                    <option>Eagles</option>
                    <option>Daughters of Faith</option>
                    <option>Youth</option>
                    <option>Kingdom Generation</option>
                    <option>Planning Committee</option>
                </select>
            </div>

            <div class="flex-between mt-2">
                <button type="button" class="btn btn-secondary" onclick="app.closeModal('cash')">Cancel</button>
                <button type="submit" class="btn btn-primary">Record Payment</button>
            </div>
        </form>
    </dialog>

    <!-- Add Expense Modal -->
    <dialog class="modal" id="modal-expense">
        <form method="dialog">
            <h2 style="margin-bottom: 24px;">Record Expense</h2>
            
            <div class="form-group">
                <label>Description</label>
                <input type="text" id="e-desc" placeholder="e.g. Transport, Printing" required>
            </div>

            <div class="form-grid">
                <div class="form-group">
                    <label>Amount (KES)</label>
                    <input type="number" id="e-amount" min="0" placeholder="0.00" required>
                </div>
                <div class="form-group">
                    <label>Category</label>
                    <select id="e-cat">
                        <option>Operations</option>
                        <option>Logistics</option>
                        <option>Administrative</option>
                        <option>Land Costs</option>
                    </select>
                </div>
            </div>

            <div class="flex-between mt-2">
                <button type="button" class="btn btn-secondary" onclick="app.closeModal('expense')">Cancel</button>
                <button type="submit" class="btn btn-danger">Save Expense</button>
            </div>
        </form>
    </dialog>

    <script>
        /**
         * DCD Possess The Land - Core Application Logic
         * Lightweight, Dependency-Free, Vanilla JS
         */

        // --- CONFIGURATION ---
        const DB_KEY = 'dcd_land_final';
        
        const DEPARTMENTS = [
            "Eagles", 
            "Daughters of Faith", 
            "Youth", 
            "Kingdom Generation", 
            "Planning Committee"
        ];

        const INITIAL_DATA = {
            pledges: [],
            transactions: [],
            expenses: [],
            phases: [
                {
                    id: 1,
                    name: "March 8th Collection",
                    date: "2024-03-08",
                    targets: {
                        "Eagles": 200000,
                        "Daughters of Faith": 200000,
                        "Youth": 200000,
                        "Kingdom Generation": 200000,
                        "Planning Committee": 200000
                    }
                }
            ]
        };

        // --- STORE CLASS ---
        class Store {
            constructor() {
                const saved = localStorage.getItem(DB_KEY);
                this.data = saved ? JSON.parse(saved) : INITIAL_DATA;
            }

            save() {
                localStorage.setItem(DB_KEY, JSON.stringify(this.data));
                app.render();
            }

            addPledge(pledge) {
                this.data.pledges.push({
                    id: Date.now(),
                    name: pledge.name,
                    phone: pledge.phone,
                    department: pledge.department,
                    amount: parseFloat(pledge.amount),
                    redeemed: 0
                });
                this.save();
            }

            addTransaction(tx) {
                // 1. Find matching pledge
                let matchedPledge = null;
                
                if (tx.department) {
                    // Priority 1: Exact Name + Department match
                    matchedPledge = this.data.pledges.find(p => 
                        p.name.toLowerCase().trim() === tx.name.toLowerCase().trim() && 
                        p.department === tx.department
                    );
                }

                if (!matchedPledge) {
                    // Priority 2: Name match only (Ambiguity handling)
                    const matches = this.data.pledges.filter(p => 
                        p.name.toLowerCase().trim() === tx.name.toLowerCase().trim()
                    );
                    if (matches.length === 1) {
                        matchedPledge = matches[0];
                    }
                }

                if (matchedPledge) {
                    // Update pledge redemption
                    tx.name = matchedPledge.name; // Normalize name
                    tx.department = matchedPledge.department; // Normalize dept
                    tx.pledgeId = matchedPledge.id;
                    
                    matchedPledge.redeemed = (matchedPledge.redeemed || 0) + tx.amount;
                } else {
                    tx.pledgeId = null;
                }

                this.data.transactions.unshift(tx);
                this.save();
            }

            addExpense(expense) {
                this.data.expenses.unshift({
                    id: Date.now(),
                    date: new Date().toISOString(),
                    description: expense.description,
                    amount: parseFloat(expense.amount),
                    category: expense.category
                });
                this.save();
            }

            addPhase(phase) {
                const total = Object.values(phase.targets).reduce((a, b) => a + b, 0);
                this.data.phases.push({
                    id: Date.now(),
                    ...phase,
                    totalTarget: total
                });
                // Sort phases by date
                this.data.phases.sort((a, b) => new Date(a.date) - new Date(b.date));
                this.save();
            }

            deletePhase(id) {
                this.data.phases = this.data.phases.filter(p => p.id !== id);
                this.save();
            }

            reset() {
                if(confirm("Are you sure you want to delete ALL data? This cannot be undone.")) {
                    localStorage.removeItem(DB_KEY);
                    location.reload();
                }
            }
        }

        const store = new Store();
        let stagedTransactions = []; // Temporary holding area for parsed SMS

        // --- APP LOGIC ---
        const app = {
            init: () => {
                app.render();
            },

            navigate: (viewId) => {
                // Hide all sections
                document.querySelectorAll('section').forEach(el => el.classList.add('hidden'));
                
                // Show target section
                document.getElementById(`view-${viewId}`).classList.remove('hidden');
                
                // Update Nav
                document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
                
                // Find the nav item that calls this function (approximate matching)
                const target = event.target.closest('.nav-item');
                if (target) target.classList.add('active');
            },

            // --- FORM HANDLING ---
            openModal: (id) => {
                const modal = document.getElementById(`modal-${id}`);
                if (modal) {
                    modal.showModal(); // Native HTML5 API
                }
            },

            closeModal: (id) => {
                const modal = document.getElementById(`modal-${id}`);
                if (modal) {
                    modal.close();
                    // Reset form
                    const form = modal.querySelector('form');
                    if(form) form.reset();
                }
            },

            // PLEDGE ACTIONS
            handlePledgeSubmit: (e) => {
                e.preventDefault();
                const form = e.target;
                const pledge = {
                    name: form.getElementById('p-name').value,
                    phone: form.getElementById('p-phone').value,
                    department: form.getElementById('p-dept').value,
                    amount: form.getElementById('p-amount').value
                };

                if (!pledge.name || !pledge.amount) {
                    alert("Please fill in Name and Amount.");
                    return;
                }

                store.addPledge(pledge);
                app.closeModal('pledge');
            },

            // CASH ACTIONS
            handleCashSubmit: (e) => {
                e.preventDefault();
                const form = e.target;
                
                const name = form.getElementById('c-name').value;
                const amount = parseFloat(form.getElementById('c-amount').value);
                const ref = form.getElementById('c-ref').value || 'CASH-' + Date.now();
                const dept = form.getElementById('c-dept').value;

                if (!name || !amount) {
                    alert("Please fill in Name and Amount.");
                    return;
                }

                const duplicate = store.data.transactions.find(t => t.ref === ref);
                if (duplicate) {
                    alert("Duplicate Reference Number detected.");
                    return;
                }

                store.addTransaction({
                    type: 'Cash',
                    amount: amount,
                    name: name,
                    ref: ref,
                    department: dept,
                    date: new Date().toISOString()
                });

                app.closeModal('cash');
            },

            // EXPENSE ACTIONS
            handleExpenseSubmit: (e) => {
                e.preventDefault();
                const form = e.target;
                
                const expense = {
                    description: form.getElementById('e-desc').value,
                    amount: parseFloat(form.getElementById('e-amount').value),
                    category: form.getElementById('e-cat').value
                };

                if (!expense.description || !expense.amount) {
                    alert("Please fill in Description and Amount.");
                    return;
                }

                store.addExpense(expense);
                app.closeModal('expense');
            },

            // PHASE ACTIONS
            handleAddPhase: () => {
                const name = prompt("Phase Name (e.g., March Collection):");
                const date = prompt("Target Date (YYYY-MM-DD):", new Date().toISOString().split('T')[0]);
                
                if (!name || !date) return;

                // Generate default targets (evenly distributed)
                const targets = {};
                DEPARTMENTS.forEach(d => targets[d] = 200000);

                const phase = {
                    name: name,
                    date: date,
                    targets: targets
                };

                store.addPhase(phase);
            },

            // --- PARSER LOGIC (ROBUST) ---
            parseSMS: () => {
                const input = document.getElementById('sms-input').value.trim();
                if (!input) {
                    alert("Please paste M-Pesa messages into the text area.");
                    return;
                }

                // 1. Robust Splitting: Split on "Confirmed." to avoid breaking decimals
                const messages = input.split(/ Confirmed\./i);
                
                stagedTransactions = []; // Clear staging area

                let matchCount = 0;
                let newMemberCount = 0;

                // 2. Process each chunk
                messages.forEach((chunk, index) => {
                    const text = chunk.trim();
                    
                    // Quick keyword check
                    if (!text.includes('Ksh') && !text.includes('KES') && !text.includes('received')) {
                        return; // Skip garbage
                    }

                    let amount = null;
                    let name = "Unknown";
                    let ref = "N/A";
                    let phone = null;

                    // Regex for "Received From"
                    const receivedRegex = /You have received Ksh([\d,]+\.?\d*)\s+from\s+([A-Za-z\s]+?)\s+(\d{10})/i;
                    const receivedMatch = text.match(receivedRegex);

                    // Regex for "Sent To"
                    const sentRegex = /Ksh([\d,]+\.?\d*)\s+sent to\s+([A-Z\s]+)\s+for account\s+(\w+)/i;
                    const sentMatch = text.match(sentRegex);

                    if (receivedMatch) {
                        amount = parseFloat(receivedMatch[1].replace(/,/g, ''));
                        name = receivedMatch[2] ? receivedMatch[2].trim() : "Unknown";
                        phone = receivedMatch[3] ? receivedMatch[3] : null;
                        ref = "N/A";
                    } else if (sentMatch) {
                        amount = parseFloat(sentMatch[1].replace(/,/g, ''));
                        name = "Till Payment"; // Till payments often don't have names
                        ref = sentMatch[3];
                    }

                    if (!amount) return;

                    // 3. Auto-Creation Logic
                    const existing = store.data.pledges.filter(p => p.name.toLowerCase() === name.toLowerCase());
                    const isNew = existing.length === 0;
                    if (isNew) newMemberCount++;
                    if (!isNew) matchCount++;

                    // 4. Handle Ambiguity (Josh in multiple departments)
                    let isAmbiguous = false;
                    let candidates = [];
                    let selectedDept = "Planning Committee";

                    if (existing.length > 1) {
                        isAmbiguous = true;
                        candidates = existing.map(p => p.department);
                        selectedDept = candidates[0];
                    } else if (existing.length === 1) {
                        selectedDept = existing[0].department;
                    }

                    stagedTransactions.push({
                        id: index, // Unique ID for list rendering
                        amount,
                        name,
                        ref,
                        phone,
                        isNew,
                        isAmbiguous,
                        candidates,
                        selectedDept,
                        matchedId: isNew ? null : existing[0].id
                    });
                });

                if (stagedTransactions.length === 0) {
                    alert("No valid M-Pesa messages found in the text.");
                    return;
                }

                // 5. Update UI
                const statsDiv = document.getElementById('parser-stats');
                statsDiv.style.display = 'block';
                
                document.getElementById('st-total').innerText = stagedTransactions.length;
                document.getElementById('st-new').innerText = newMemberCount;
                document.getElementById('st-matched').innerText = matchCount;
                document.getElementById('st-unmatched').innerText = 0; // In this logic, everything is either New or Matched

                const stagedList = document.getElementById('staged-list');
                stagedList.innerHTML = '';

                stagedTransactions.forEach((t) => {
                    let resolutionHTML = '';
                    let rowClass = 'matched';
                    let statusBadge = '<span class="badge badge-success">Matched</span>';

                    if (t.isNew) {
                        rowClass = 'new-member';
                        statusBadge = '<span class="badge badge-warn">New Member</span>';
                    }

                    if (t.isAmbiguous) {
                        rowClass = 'unmatched';
                        statusBadge = '<span class="badge badge-danger">Ambiguous</span>';
                        resolutionHTML = `
                            <div style="margin-top: 8px; padding: 12px; background: #FFF3E0; border-radius: 6px; font-size: 0.85rem;">
                                <strong>‚ö†Ô∏è Name exists in multiple departments.</strong><br>
                                <div style="margin-top: 8px;">
                                    <label style="display:block; margin-bottom: 4px;">Select Correct Department:</label>
                                    <select class="resolve-dept-select" data-id="${t.id}" style="width: 100%; padding: 8px;">
                                        <option value="" disabled selected>-- Select --</option>
                                        ${t.candidates.map(d => `<option value="${d}">${d}</option>`).join('')}
                                    </select>
                                </div>
                            </div>
                        `;
                    }

                    stagedList.innerHTML += `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 16px; border: 1px solid var(--border); border-radius: 8px; background: ${t.isNew ? '#F0FDF4' : 'white'}; border-left: 4px solid ${t.isNew ? 'var(--primary)' : 'var(--border)'};">
                            <div>
                                <strong>${t.name}</strong>
                                <div style="font-size: 0.8rem; color: var(--text-sub);">
                                    ${t.phone ? 'üì± ' + t.phone : ''}
                                </div>
                                <div class="text-sub" style="font-family: monospace; font-size: 0.85rem;">Ref: ${t.ref}</div>
                            </div>
                            <div style="font-weight: 700; font-size: 1.1rem; color: var(--primary);">
                                ${app.formatMoney(t.amount)}
                            </div>
                            <div>${statusBadge}</div>
                        </div>
                        ${resolutionHTML}
                    </div>
                    `;
                });

                // Show Staged Container
                document.getElementById('staged-container').style.display = (stagedTransactions.length > 0) ? 'block' : 'none';
            },

            clearParser: () => {
                document.getElementById('sms-input').value = '';
                document.getElementById('staged-container').style.display = 'none';
                document.getElementById('parser-stats').style.display = 'none';
                stagedTransactions = [];
            },

            commitAll: async () => {
                if (stagedTransactions.length === 0) return;

                const btn = document.getElementById('btn-commit-all');
                const originalText = btn.innerText;
                
                // Lock UI
                btn.innerText = "Processing...";
                btn.disabled = true;

                // Artificial delay to allow UI to update
                await new Promise(r => setTimeout(r, 100));

                let addedCount = 0;

                // Sequential Loop to ensure every transaction is fully saved
                for (const t of stagedTransactions) {
                    // Resolve department if ambiguous
                    if (t.isAmbiguous) {
                        const select = document.querySelector(`.resolve-dept-select[data-id="${t.id}"]`);
                        if (select) t.selectedDept = select.value;
                    }

                    // Create Member if new
                    if (t.isNew) {
                        store.addPledge(t);
                    }

                    // Add Transaction
                    store.addTransaction({
                        type: 'M-Pesa',
                        amount: t.amount,
                        name: t.name,
                        ref: t.ref,
                        phone: t.phone,
                        department: t.selectedDept,
                        date: new Date().toISOString(),
                        pledgeId: t.matchedId
                    });
                    
                    addedCount++;
                }

                // Cleanup
                app.clearParser();
                
                // Restore UI
                btn.innerText = originalText;
                btn.disabled = false;

                if (addedCount > 0) {
                    alert(`‚úÖ Success! Added ${addedCount} transactions to ledger.`);
                }
            },

            // --- RENDER LOGIC ---
            render: () => {
                // 1. Calculations
                const totalCash = store.data.transactions.reduce((sum, t) => sum + t.amount, 0);
                const totalExpenses = store.data.expenses.reduce((sum, e) => sum + e.amount, 0);
                const netBalance = totalCash - totalExpenses;

                // 2. Dashboard Cards
                document.getElementById('dash-cash').innerText = app.formatMoney(totalCash);
                document.getElementById('dash-balance').innerText = app.formatMoney(netBalance);
                
                const totalPledged = store.data.pledges.reduce((sum, p) => sum + p.amount, 0);
                document.getElementById('dash-pledges').innerText = app.formatMoney(totalPledged);

                // 3. Leaderboard
                const lbBody = document.getElementById('leaderboard-body');
                lbBody.innerHTML = '';

                // Find current phase
                const today = new Date();
                let currentPhase = store.data.phases.find(p => new Date(p.date) >= today) || store.data.phases[store.data.phases.length - 1];

                if (!currentPhase) {
                    lbBody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 20px;">No active phase set.</td></tr>';
                } else {
                    const deptStats = DEPARTMENTS.map(dept => {
                        const deptCash = store.data.transactions
                            .filter(t => t.department === dept)
                            .reduce((sum, t) => sum + t.amount, 0);
                        const target = currentPhase.targets[dept] || 0;
                        const pct = target ? Math.min(100, (deptCash / target) * 100) : 0;
                        return { dept, deptCash, target, pct };
                    }).sort((a, b) => b.pct - a.pct);

                    deptStats.forEach((stat, index) => {
                        const rank = index + 1;
                        const rankColor = rank === 1 ? '#FFD700' : rank === 2 ? '#C0C0C0' : '#CD7F32';
                        
                        lbBody.innerHTML += `
                            <tr>
                                <td><div style="width: 24px; height: 24px; border-radius: 50%; background: ${rankColor}; color: white; display: flex; align-items: center; justify-content: center; font-weight: bold;">${rank}</td>
                                <td style="font-weight: 500;">${stat.dept}</td>
                                <td class="text-right">${app.formatMoney(stat.target)}</td>
                                <td class="text-right">${app.formatMoney(stat.deptCash)}</td>
                                <td>
                                    <div class="progress-track" style="height: 8px; width: 100px;">
                                        <div class="progress-fill" style="width: ${stat.pct}%;"></div>
                                    </div>
                                    <div style="text-align: center; width: 100px; font-size: 0.75rem; margin-left: 10px;">${stat.pct.toFixed(1)}%</div>
                                </td>
                                <td style="text-align: center;">${stat.pct > 90 ? 'üöÄ' : (stat.pct > 50 ? 'üí®' : '')}</td>
                            </tr>
                        `;
                    });
                }
                
                // 4. Phases Timeline
                const timelineContainer = document.getElementById('phase-timeline-container');
                timelineContainer.innerHTML = '';

                store.data.phases.forEach((phase, index) => {
                    const pct = Math.min(100, (totalCash / phase.totalTarget) * 100).toFixed(1);
                    const isPast = new Date(phase.date) < new Date();

                    let statusColor = '#E5E7EB'; // Default gray
                    if (parseFloat(pct) >= 100) statusColor = 'var(--primary-light)';
                    else if (isPast) statusColor = '#EF4444';

                    timelineContainer.innerHTML += `
                        <div style="margin-bottom: 24px; padding-left: 24px; border-left: 4px solid ${statusColor}; position: relative;">
                            <div style="position: absolute; left: -30px; top: 6px; width: 12px; height: 12px; background: white; border-radius: 50%; border: 2px solid ${statusColor};"></div>
                            <div>
                                <div style="font-weight: 600; color: var(--text-main);">${phase.name}</div>
                                <div style="font-size: 0.85rem; color: var(--text-sub); margin-top: 4px;">${new Date(phase.date).toLocaleDateString()}</div>
                            </div>
                            <div class="text-right" style="margin-top: 8px;">
                                <span style="font-weight: bold; font-size: 1.2rem;">${pct}%</span>
                            </div>
                        </div>
                        <div class="progress-track" style="height: 8px; margin-top: 8px;">
                            <div class="progress-fill" style="width: ${pct}%; background-color: ${statusColor};"></div>
                        </div>
                    </div>
                    `;
                });

                // 5. Recent Activity
                const recentList = document.getElementById('recent-activity-list');
                if (store.data.transactions.length === 0) {
                    recentList.innerHTML = '<p class="text-sub" style="text-align: center; padding: 20px;">No recent activity yet.</p>';
                } else {
                    recentList.innerHTML = '';
                    store.data.transactions.slice(0, 5).forEach(t => {
                        const icon = t.type === 'Cash' ? 'üíµ' : 'üì±';
                        const time = new Date(t.date).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                        
                        recentList.innerHTML += `
                            <div style="display: flex; gap: 12px; align-items: center; padding: 12px; background: white; border: 1px solid var(--border); border-radius: 8px;">
                                <div style="width: 24px; height: 24px; background: #E0F2FE; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 1rem;">${icon}</div>
                                <div>
                                    <div style="font-weight: 600; color: var(--text-main);">${t.name}</div>
                                    <div class="text-sub" style="font-size: 0.85rem;">${t.type} ‚Ä¢ ${time}</div>
                                </div>
                                <div class="text-right money">${app.formatMoney(t.amount)}</div>
                            </div>
                        </div>
                        `;
                    });
                }

                // 6. Pledges Table
                const pledgesBody = document.getElementById('pledges-body');
                pledgesBody.innerHTML = '';
                
                store.data.pledges.forEach(p => {
                    const redeemed = p.redeemed || 0;
                    const remaining = p.amount - redeemed;
                    const pct = p.amount > 0 ? (redeemed / p.amount) * 100 : 0;
                    const status = pct >= 100 ? 
                        '<span class="badge badge-success">Paid</span>' : 
                        `<span class="badge badge-warn">${pct.toFixed(0)}%</span>`;

                    pledgesBody.innerHTML += `
                        <tr>
                            <td style="font-weight: 500;">${p.name}</td>
                            <td>${p.department}</td>
                            <td class="text-right">${app.formatMoney(p.amount)}</td>
                            <td class="text-right">${app.formatMoney(redeemed)}</td>
                            <td class="text-right" style="color: ${remaining > 0 ? 'var(--danger)' : 'var(--text-sub)'};">${app.formatMoney(remaining)}</td>
                            <td>
                                ${remaining > 0 ? 
                                    `<button class="btn btn-secondary btn-sm" onclick="app.quickPay(${p.id})">Pay</button>` : 
                                    '<span style="opacity: 0.5;">-</span>'}
                            </td>
                        </tr>
                    `;
                });

                // 7. Ledger Table
                const ledgerBody = document.getElementById('ledger-body');
                ledgerBody.innerHTML = '';

                // Merge expenses and transactions for ledger view
                const ledgerRows = [
                    ...store.data.transactions.map(t => ({ ...t, badgeClass: 'badge-success', category: 'Income' })),
                    ...store.data.expenses.map(e => ({ ...e, badgeClass: 'badge-danger', category: 'Expense' }))
                ].sort((a, b) => new Date(b.date || a.date) - new Date(a.date));

                ledgerRows.forEach(row => {
                    ledgerBody.innerHTML += `
                        <tr>
                            <td style="color: var(--text-sub); font-size: 0.85rem;">${new Date(row.date).toLocaleDateString()}</td>
                            <td style="font-family: monospace;">${row.ref || '-'}</td>
                            <td>${row.name}</td>
                            <td class="text-right">${app.formatMoney(row.amount)}</td>
                            <td><span class="badge ${row.badgeClass}">${row.category}</span></td>
                            <td>${row.pledgeId ? '‚úÖ Yes' : '-'}</td>
                        </tr>
                    `;
                });

                // 8. Tribes Grid
                const tribesGrid = document.getElementById('tribes-grid');
                tribesGrid.innerHTML = '';

                DEPARTMENTS.forEach(dept => {
                    // Calculate cash collected for this dept
                    const deptCash = store.data.transactions
                        .filter(t => t.department === dept)
                        .reduce((sum, t) => sum + t.amount, 0);

                    // Calculate progress
                    const target = currentPhase.targets[dept] || 0;
                    const pct = target > 0 ? Math.min(100, (deptCash / target) * 100) : 0;

                    tribesGrid.innerHTML += `
                        <div class="card" style="border-top: 4px solid ${deptCash >= target ? 'var(--primary)' : 'var(--border)'}">
                            <div class="flex-between" style="margin-bottom: 12px;">
                                <div>
                                    <div style="font-weight: 600; color: var(--text-main); font-size: 1.1rem;">${dept}</div>
                                    <div class="text-sub">Target: ${app.formatMoney(target)}</div>
                                </div>
                                <div style="text-right">
                                    <div style="font-weight: 700; font-size: 1.2rem; color: var(--primary-dark);">${app.formatMoney(deptCash)}</div>
                                    <div style="font-size: 0.9rem; color: var(--text-sub);">(${pct.toFixed(1)}%)</div>
                                </div>
                            </div>
                            <div class="progress-track" style="height: 10px; margin-top: 12px;">
                                <div class="progress-fill" style="width: ${pct}%;"></div>
                            </div>
                        </div>
                    `;
                });

                // 9. Settings
                const phasesList = document.getElementById('phases-list');
                phasesList.innerHTML = '';

                store.data.phases.forEach(phase => {
                    phasesList.innerHTML += `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 16px; background: var(--bg); border-radius: 8px; border: 1px solid var(--border);">
                            <div>
                                <div style="font-weight: 600;">${phase.name}</div>
                                <div class="text-sub">${new Date(phase.date).toLocaleDateString()}</div>
                            </div>
                            <button class="btn btn-secondary btn-sm" onclick="store.deletePhase(${phase.id})">Delete</button>
                        </div>
                    `;
                });
            },

            // --- UTILS ---
            formatMoney: (num) => {
                return new Intl.NumberFormat('en-KE', { style: 'currency', currency: 'KES' }).format(num);
            },
            
            exportCSV: (type) => {
                let csv = "data:text/csv;charset=utf-8,";
                
                if (type === 'pledges') {
                    csv += "Name,Phone,Department,Amount,Redeemed,Remaining\n";
                    store.data.pledges.forEach(p => {
                        csv += `"${p.name}","${p.phone || ''}","${p.department}",${p.amount},${p.redeemed || 0},${p.amount - (p.redeemed || 0)}\n`;
                    });
                } else {
                    csv += "Date,Type,Description,Reference,Amount\n";
                    // Combine and sort
                    const rows = [
                        ...store.data.transactions.map(t => ({...t, Type: 'Income', Category: 'M-Pesa', Ref: t.ref || '' })),
                        ...store.data.expenses.map(e => ({...e, Type: 'Expense', Category: e.category, Ref: 'EXP-' + Date.now(), Amount: e.amount }))
                    ].sort((a, b) => new Date(a.date) - new Date(b.date));

                    rows.forEach(r => {
                        csv += `${new Date(r.date).toLocaleDateString()},${r.Type},${r.Description},${r.Ref},${r.amount}\n`;
                    });
                }

                const blob = new Blob([csv], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `dcd_land_${type}_${Date.now()}.csv`;
                document.body.appendChild(a);
                a.click();
            },

            // --- QUICK PAY (LINKED TO PLEDGE) ---
            quickPay: (pledgeId) => {
                // Re-open modal with pre-filled data?
                const pledge = store.data.pledges.find(p => p.id === pledgeId);
                if(!pledge) return;

                // Populate cash modal
                const modal = document.getElementById('modal-cash');
                modal.querySelector('#c-name').value = pledge.name;
                modal.querySelector('#c-dept').value = pledge.department;
                modal.showModal();
            }
        };

        // --- EVENT LISTENERS ---
        document.getElementById('modal-pledge').addEventListener('submit', app.handlePledgeSubmit);
        document.getElementById('modal-cash').addEventListener('submit', app.handleCashSubmit);
        document.getElementById('modal-expense').addEventListener('submit', app.handleExpenseSubmit);
        
        // Init
        app.init();
    </script>
</body>
</html>
