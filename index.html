<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LandQuest Mobilizer</title>
    <style>
        :root {
            --primary: #059669; /* Emerald Green */
            --primary-dark: #064E3B;
            --secondary: #3B82F6; /* Blue */
            --accent: #F59E0B; /* Amber */
            --danger: #EF4444;
            --bg: #F3F4F6;
            --surface: #FFFFFF;
            --text-main: #1F2937;
            --text-sub: #6B7280;
            --border: #E5E7EB;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
        
        body { background-color: var(--bg); color: var(--text-main); display: flex; height: 100vh; overflow: hidden; }

        /* --- Layout --- */
        aside {
            width: 260px;
            background: #111827;
            color: white;
            display: flex;
            flex-direction: column;
            padding: 20px;
            z-index: 50;
        }

        main { flex: 1; overflow-y: auto; padding: 24px; position: relative; }

        /* --- Sidebar Nav --- */
        .brand { font-size: 1.1rem; font-weight: 800; margin-bottom: 40px; color: var(--primary); letter-spacing: 1px; display: flex; align-items: center; gap: 10px; line-height: 1.2;}
        .nav-item {
            padding: 12px; margin-bottom: 5px; border-radius: 8px; cursor: pointer;
            display: flex; align-items: center; gap: 12px; color: #9CA3AF; transition: 0.2s; font-size: 0.95rem;
        }
        .nav-item:hover { background: #374151; color: white; }
        .nav-item.active { background: var(--primary); color: white; font-weight: 600; }

        /* --- Mobile Nav --- */
        @media (max-width: 768px) {
            body { flex-direction: column; }
            aside { 
                width: 100%; height: auto; position: fixed; bottom: 0; left: 0; 
                flex-direction: row; padding: 10px; justify-content: space-around; 
                border-top: 1px solid var(--border); background: white; color: #333;
            }
            .brand { display: none; }
            .nav-item { flex-direction: column; gap: 4px; font-size: 0.7rem; text-align: center; padding: 5px; }
            main { padding-bottom: 80px; }
        }

        /* --- Components --- */
        .card { background: var(--surface); padding: 20px; border-radius: 12px; border: 1px solid var(--border); box-shadow: var(--shadow); margin-bottom: 24px; }
        .grid-2 { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; }
        .grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; }
        
        @media(max-width: 1000px) { .grid-3 { grid-template-columns: 1fr 1fr; } }
        @media(max-width: 768px) { .grid-2, .grid-3 { grid-template-columns: 1fr; } }

        h1, h2, h3 { margin-bottom: 12px; color: var(--text-main); }
        .text-sub { color: var(--text-sub); font-size: 0.9rem; }
        .text-lg { font-size: 1.5rem; font-weight: 700; }
        .text-xl { font-size: 2rem; font-weight: 800; color: var(--primary-dark); }
        .text-sm { font-size: 0.8rem; }

        /* --- Buttons & Inputs --- */
        .btn {
            padding: 10px 20px; border-radius: 8px; border: none; cursor: pointer; font-weight: 600;
            transition: 0.2s; display: inline-flex; align-items: center; gap: 8px;
        }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-dark); }
        .btn-secondary { background: white; border: 1px solid var(--border); color: var(--text-main); }
        .btn-danger { background: var(--danger); color: white; }
        .btn-sm { padding: 6px 12px; font-size: 0.85rem; }

        input, select, textarea {
            width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 8px; margin-bottom: 10px;
        }
        input:focus { outline: 2px solid var(--primary); border-color: transparent; }

        /* --- Progress Bars --- */
        .progress-track { background: #E5E7EB; height: 12px; border-radius: 6px; overflow: hidden; margin-top: 8px; position: relative; }
        .progress-fill { height: 100%; background: var(--primary); width: 0%; transition: width 0.5s ease; }
        .progress-fill.amber { background: var(--accent); }
        .progress-fill.danger { background: var(--danger); }

        /* --- Phase Timeline --- */
        .phase-timeline { border-left: 3px solid var(--border); padding-left: 20px; margin-left: 10px; }
        .phase-item { position: relative; margin-bottom: 30px; padding-left: 20px; }
        .phase-item::before {
            content: ''; position: absolute; left: -26px; top: 5px;
            width: 16px; height: 16px; border-radius: 50%; background: var(--bg); border: 3px solid var(--border);
        }
        .phase-item.active::before { border-color: var(--primary); background: var(--primary); }
        .phase-item.completed::before { border-color: var(--primary-dark); background: var(--primary-dark); }

        /* --- Tables --- */
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid var(--border); font-size: 0.9rem; }
        th { background: #F9FAFB; color: var(--text-sub); font-weight: 600; text-transform: uppercase; font-size: 0.75rem; }
        .badge { padding: 4px 8px; border-radius: 20px; font-size: 0.7rem; font-weight: 700; }
        .badge-success { background: #D1FAE5; color: #065F46; }
        .badge-warn { background: #FEF3C7; color: #92400E; }

        /* --- Reconciler Box --- */
        .reconciler-area { background: #ECFDF5; border: 2px dashed var(--primary); padding: 20px; border-radius: 12px; text-align: center; cursor: text; }
        .reconciler-area:focus { background: white; border-style: solid; outline: none; }

        /* --- Utility Classes --- */
        .hidden { display: none !important; }
        .flex-between { display: flex; justify-content: space-between; align-items: center; }
        .mt-4 { margin-top: 16px; }

        /* --- Modal --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 100;
        }
        .modal { background: white; width: 90%; max-width: 500px; padding: 24px; border-radius: 12px; }
    </style>
</head>
<body>

    <!-- SIDEBAR -->
    <aside>
        <div class="brand">üåç<br>LandQuest<br>Mobilizer</div>
        <div class="nav-item active" onclick="app.nav('dashboard')">üìä Dashboard</div>
        <div class="nav-item" onclick="app.nav('pledges')">ü§ù Pledges</div>
        <div class="nav-item" onclick="app.nav('ledger')">üí∞ Ledger</div>
        <div class="nav-item" onclick="app.nav('tribes')">üè¢ Tribes</div>
        <div class="nav-item" onclick="app.nav('strategy')">üß† Strategy</div>
        <div style="margin-top: auto;" class="nav-item" onclick="app.nav('settings')">‚öôÔ∏è Settings</div>
    </aside>

    <!-- MAIN CONTENT -->
    <main>
        
        <!-- DASHBOARD VIEW -->
        <section id="view-dashboard">
            <header class="flex-between" style="margin-bottom: 20px;">
                <div>
                    <h1>Project Overview</h1>
                    <p class="text-sub">Real-time status of collections & pledges</p>
                </div>
                <button class="btn btn-primary" onclick="app.openModal('pledge')">+ New Pledge</button>
            </header>

            <!-- KPIs -->
            <div class="grid-3">
                <div class="card">
                    <h3 class="text-sub">Total Cash Collected</h3>
                    <div class="text-xl" id="dash-cash">0</div>
                </div>
                <div class="card">
                    <h3 class="text-sub">Total Pledges</h3>
                    <div class="text-xl" id="dash-pledges">0</div>
                </div>
                <div class="card">
                    <h3 class="text-sub">Redemption Rate</h3>
                    <div class="text-xl" id="dash-rate">0%</div>
                    <p class="text-sub">Cash / Pledged</p>
                </div>
            </div>

            <!-- PHASE PROGRESS -->
            <div class="card">
                <div class="flex-between">
                    <h3>üìÖ Collection Phases Timeline</h3>
                    <button class="btn btn-secondary btn-sm" onclick="app.nav('settings')">Edit Phases</button>
                </div>
                <p class="text-sub">Progress towards specific deadlines</p>
                
                <div id="phase-timeline-container" class="phase-timeline mt-4">
                    <!-- Populated by JS -->
                </div>
            </div>
        </section>

        <!-- PLEDGES VIEW -->
        <section id="view-pledges" class="hidden">
            <div class="flex-between">
                <h1>Pledge Ledger</h1>
                <button class="btn btn-primary" onclick="app.openModal('pledge')">+ Add Pledge</button>
            </div>
            <div class="card mt-4">
                <table>
                    <thead>
                        <tr>
                            <th>Member</th>
                            <th>Tribe (Dept)</th>
                            <th>Committed</th>
                            <th>Redeemed</th>
                            <th>Status</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="pledges-table"></tbody>
                </table>
            </div>
        </section>

        <!-- LEDGER & RECONCILE VIEW -->
        <section id="view-ledger" class="hidden">
            <h1>Transaction Reconciliation</h1>
            
            <div class="card mt-4" style="border-left: 5px solid var(--primary);">
                <h3>ü§ñ M-Pesa SMS Parser</h3>
                <p class="text-sub">Paste raw M-Pesa messages. We'll extract Amount, Name, and match to Pledges.</p>
                
                <div class="reconciler-area" contenteditable="true" id="sms-input" 
                     oninput="app.parseSMS(this.innerText)"
                     onclick="if(this.innerText === 'Paste M-Pesa messages here...') { this.innerText = ''; }">
                    Paste M-Pesa messages here...
                </div>

                <div id="staged-container" class="hidden">
                    <div class="flex-between mt-4">
                        <h4>Staged Transactions (<span id="staged-count">0</span>)</h4>
                        <div>
                            <button class="btn btn-secondary btn-sm" onclick="app.clearStaged()">Clear</button>
                            <button class="btn btn-primary btn-sm" onclick="app.commitStaged()">‚úÖ Add All</button>
                        </div>
                    </div>
                    <div id="staged-list" style="margin-top:15px;"></div>
                </div>
            </div>

            <h2 class="mt-4">Verified Ledger</h2>
            <div class="card">
                <table>
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Ref</th>
                            <th>Member</th>
                            <th>Amount</th>
                            <th>Linked Pledge</th>
                        </tr>
                    </thead>
                    <tbody id="ledger-table"></tbody>
                </table>
            </div>
        </section>

        <!-- TRIBES VIEW -->
        <section id="view-tribes" class="hidden">
            <h1>Tribe Performance</h1>
            <div class="grid-2 mt-4" id="tribes-grid">
                <!-- Populated by JS -->
            </div>
        </section>

        <!-- STRATEGY VIEW -->
        <section id="view-strategy" class="hidden">
            <h1>üß† Strategy Engine</h1>
            <div class="card mt-4" style="background: #F0FDF4; border-color: var(--primary);">
                <h2 style="color: var(--primary-dark);">AI Insights</h2>
                <p class="text-sub">Actionable advice based on timeline & performance:</p>
                <div id="strategy-content" class="mt-4">
                    <!-- JS Generated -->
                </div>
            </div>
        </section>

        <!-- SETTINGS VIEW (ADMIN) -->
        <section id="view-settings" class="hidden">
            <h1>‚öôÔ∏è Admin Configuration</h1>
            
            <div class="card">
                <h3>Manage Collection Phases</h3>
                <p class="text-sub">Set targets for specific deadlines (e.g., March 8th).</p>
                
                <form onsubmit="app.addPhase(event)" class="mt-4" style="background: #f9fafb; padding: 15px; border-radius: 8px;">
                    <div class="grid-2">
                        <div>
                            <label class="text-sm">Phase Name</label>
                            <input type="text" id="s-name" placeholder="e.g. March 8th Collection" required>
                        </div>
                        <div>
                            <label class="text-sm">Target Date</label>
                            <input type="date" id="s-date" required>
                        </div>
                    </div>
                    <div style="margin-top: 10px;">
                        <label class="text-sm">Target Amount (KES)</label>
                        <input type="number" id="s-amount" placeholder="0" required>
                    </div>
                    <button type="submit" class="btn btn-primary mt-4">+ Add Phase</button>
                </form>

                <div id="settings-phase-list" class="mt-4">
                    <!-- List of phases with delete buttons -->
                </div>
            </div>

            <div class="card" style="border-color: var(--danger);">
                <h3 style="color: var(--danger);">Danger Zone</h3>
                <p class="text-sub">Reset the entire project. This cannot be undone.</p>
                <button class="btn btn-danger btn-sm mt-4" onclick="if(confirm('Are you sure? This deletes all data.')) { localStorage.removeItem('landquest_db'); location.reload(); }">Reset All Data</button>
            </div>
        </section>

    </main>

    <!-- MODAL: ADD PLEDGE -->
    <div class="modal-overlay" id="modal-pledge">
        <div class="modal">
            <h2>Add New Pledge</h2>
            <form onsubmit="app.addPledge(event)">
                <label class="text-sub">Member Name</label>
                <input type="text" id="p-name" required>
                
                <label class="text-sub">Tribe (Department)</label>
                <select id="p-dept" required>
                    <option>Eagles</option>
                    <option>Daughters of Faith</option>
                    <option>Youth</option>
                    <option>Kingdom Generation</option>
                    <option>Planning Committee</option>
                </select>

                <label class="text-sub">Pledged Amount (KES)</label>
                <input type="number" id="p-amount" required>

                <div class="flex-between mt-4">
                    <button type="button" class="btn btn-secondary" onclick="app.closeModal('pledge')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Pledge</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // --- DATA STORE ---
        const DB_KEY = 'landquest_db_v2';
        
        // Specific Tribes
        const DEPARTMENTS = [
            "Eagles", 
            "Daughters of Faith", 
            "Youth", 
            "Kingdom Generation", 
            "Planning Committee"
        ];

        // Default Phases (Admin can change these)
        const defaultPhases = [
            { id: 1, name: "March 8th Collection", date: "2024-03-08", target: 2000000 }, // Example initial phase
            { id: 2, name: "Phase 2 Target", date: "2024-06-01", target: 4000000 } // Cumulative or separate? Let's do cumulative targets for simplicity in visualization
        ];

        const initialData = {
            pledges: [],
            transactions: [],
            phases: defaultPhases 
        };

        class Store {
            constructor() {
                const saved = localStorage.getItem(DB_KEY);
                this.data = saved ? JSON.parse(saved) : initialData;
            }

            save() {
                localStorage.setItem(DB_KEY, JSON.stringify(this.data));
                app.render();
            }

            addPledge(name, dept, amount) {
                this.data.pledges.push({
                    id: Date.now(),
                    name, dept, amount: Number(amount), redeemed: 0
                });
                this.save();
            }

            addTransaction(tx) {
                this.data.transactions.unshift({
                    id: Date.now(),
                    date: new Date().toISOString(),
                    amount: tx.amount,
                    name: tx.name,
                    ref: tx.ref,
                    pledgeId: tx.matchedId
                });

                if(tx.matchedId) {
                    const pledge = this.data.pledges.find(p => p.id === tx.matchedId);
                    if(pledge) {
                        pledge.redeemed = (pledge.redeemed || 0) + tx.amount;
                    }
                }
                this.save();
            }

            addPhase(name, date, target) {
                this.data.phases.push({
                    id: Date.now(),
                    name, date, target: Number(target)
                });
                // Sort phases by date
                this.data.phases.sort((a,b) => new Date(a.date) - new Date(b.date));
                this.save();
            }

            deletePhase(id) {
                this.data.phases = this.data.phases.filter(p => p.id !== id);
                this.save();
            }
        }

        const store = new Store();
        let stagedTransactions = [];

        const app = {
            init: () => {
                app.render();
            },

            nav: (viewId) => {
                document.querySelectorAll('main section').forEach(el => el.classList.add('hidden'));
                document.getElementById(`view-${viewId}`).classList.remove('hidden');
                document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
                event.currentTarget.classList.add('active');
            },

            render: () => {
                // 1. Calculations
                const totalCash = store.data.transactions.reduce((sum, t) => sum + t.amount, 0);
                const totalPledged = store.data.pledges.reduce((sum, p) => sum + p.amount, 0);
                const totalRedeemed = store.data.pledges.reduce((sum, p) => sum + (p.redeemed || 0), 0);
                const rate = totalPledged > 0 ? ((totalRedeemed / totalPledged) * 100).toFixed(1) : 0;

                // Update KPI Cards
                document.getElementById('dash-cash').textContent = app.formatMoney(totalCash);
                document.getElementById('dash-pledges').textContent = app.formatMoney(totalPledged);
                document.getElementById('dash-rate').textContent = `${rate}%`;

                // 2. Phase Timeline Logic
                const timelineDiv = document.getElementById('phase-timeline-container');
                timelineDiv.innerHTML = '';
                
                const today = new Date();
                let cumulativeTarget = 0;

                store.data.phases.forEach((phase, index) => {
                    cumulativeTarget += phase.target;
                    const phaseDate = new Date(phase.date);
                    const isPast = phaseDate < today;
                    
                    // Progress for this phase: Cash / Cumulative Target
                    const phasePct = Math.min(100, (totalCash / cumulativeTarget) * 100).toFixed(1);
                    
                    let statusClass = 'active';
                    if(phasePct >= 100) statusClass = 'completed';
                    else if(isPast && phasePct < 100) statusClass = 'danger'; // Missed deadline

                    timelineDiv.innerHTML += `
                        <div class="phase-item ${statusClass}">
                            <div class="flex-between">
                                <strong>${phase.name}</strong>
                                <small class="text-sub">${phase.date}</small>
                            </div>
                            <div class="flex-between mt-4">
                                <span class="text-sm">Target: ${app.formatMoney(cumulativeTarget)}</span>
                                <span class="text-sm font-bold">${phasePct}%</span>
                            </div>
                            <div class="progress-track">
                                <div class="progress-fill ${statusClass === 'danger' ? 'danger' : ''}" style="width: ${phasePct}%;"></div>
                            </div>
                            <small class="text-sub">Cumulative Target Required</small>
                        </div>
                    `;
                });

                // 3. Pledge Table
                const pTable = document.getElementById('pledges-table');
                pTable.innerHTML = '';
                store.data.pledges.forEach(p => {
                    const pct = ((p.redeemed || 0) / p.amount) * 100;
                    const status = pct >= 100 ? '<span class="badge badge-success">Paid</span>' : `<span class="badge badge-warn">${pct.toFixed(0)}%</span>`;
                    
                    pTable.innerHTML += `
                        <tr>
                            <td><strong>${p.name}</strong></td>
                            <td>${p.dept}</td>
                            <td>${app.formatMoney(p.amount)}</td>
                            <td>${app.formatMoney(p.redeemed || 0)}</td>
                            <td>${status}</td>
                            <td>
                                <button class="btn btn-secondary btn-sm" onclick="app.quickPay(${p.id})">+ Pay</button>
                            </td>
                        </tr>
                    `;
                });

                // 4. Ledger Table
                const lTable = document.getElementById('ledger-table');
                lTable.innerHTML = '';
                store.data.transactions.forEach(t => {
                    const linked = t.pledgeId ? '‚úÖ Yes' : '-';
                    lTable.innerHTML += `
                        <tr>
                            <td>${new Date(t.date).toLocaleDateString()}</td>
                            <td style="font-family:monospace;">${t.ref}</td>
                            <td>${t.name}</td>
                            <td>${app.formatMoney(t.amount)}</td>
                            <td>${linked}</td>
                        </tr>
                    `;
                });

                // 5. Tribes Grid
                const tGrid = document.getElementById('tribes-grid');
                tGrid.innerHTML = '';
                DEPARTMENTS.forEach(dept => {
                    const deptPledges = store.data.pledges.filter(p => p.dept === dept);
                    const deptPledgedTotal = deptPledges.reduce((sum, p) => sum + p.amount, 0);
                    const deptCash = deptPledges.reduce((sum, p) => sum + (p.redeemed || 0), 0);
                    const activeMembers = deptPledges.length;

                    tGrid.innerHTML += `
                        <div class="card">
                            <div class="flex-between">
                                <h3>${dept}</h3>
                                <small class="badge badge-warn">${activeMembers} Members</small>
                            </div>
                            <div class="mt-4">
                                <small class="text-sub">Pledged: ${app.formatMoney(deptPledgedTotal)}</small>
                                <div class="progress-track"><div class="progress-fill amber" style="width: ${deptPledgedTotal ? (deptCash/deptPledgedTotal)*100 : 0}%"></div></div>
                            </div>
                            <div class="mt-4">
                                <small class="text-sub">Collected: ${app.formatMoney(deptCash)}</small>
                            </div>
                        </div>
                    `;
                });

                // 6. Settings Phase List
                const sList = document.getElementById('settings-phase-list');
                sList.innerHTML = '';
                store.data.phases.forEach(p => {
                    sList.innerHTML += `
                        <div style="padding: 10px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong>${p.name}</strong><br>
                                <small>${p.date} - Target: ${app.formatMoney(p.target)}</small>
                            </div>
                            <button class="btn btn-danger btn-sm" onclick="store.deletePhase(${p.id})">Delete</button>
                        </div>
                    `;
                });

                // 7. Strategy Engine
                const stratDiv = document.getElementById('strategy-content');
                let advice = [];
                
                // Find upcoming deadline
                const upcomingPhase = store.data.phases.find(p => new Date(p.date) >= today);
                
                if(upcomingPhase) {
                    // Cumulative target logic for strategy
                    const cumulativeUpToPhase = store.data.phases
                        .filter(p => new Date(p.date) <= new Date(upcomingPhase.date))
                        .reduce((sum, p) => sum + p.target, 0);
                        
                    const gap = cumulativeUpToPhase - totalCash;
                    
                    if(gap > 0) {
                        advice.push(`üö® <strong>Deadline Alert:</strong> You need ${app.formatMoney(gap)} more by <strong>${upcomingPhase.date}</strong> to meet the ${upcomingPhase.name} target.`);
                    } else {
                        advice.push(`‚úÖ <strong>Great News:</strong> You have met the target for ${upcomingPhase.name}!`);
                    }
                } else {
                    advice.push("üéâ <strong>Victory Lap:</strong> All immediate collection phases are complete or passed.");
                }

                if(totalRedeemed < totalPledged * 0.4) {
                    advice.push("üìû <strong>Follow-up:</strong> Many pledges are pending. Initiate a calling campaign to fulfill commitments.");
                }

                stratDiv.innerHTML = advice.map(a => `<p style="margin-bottom:10px; padding:10px; background:white; border-radius:6px;">${a}</p>`).join('');
            },

            openModal: (type) => document.getElementById(`modal-${type}`).style.display = 'flex',
            closeModal: (type) => document.getElementById(`modal-${type}`).style.display = 'none',
            
            addPledge: (e) => {
                e.preventDefault();
                const name = document.getElementById('p-name').value;
                const dept = document.getElementById('p-dept').value;
                const amount = document.getElementById('p-amount').value;
                store.addPledge(name, dept, amount);
                app.closeModal('pledge');
                document.getElementById('p-name').value = '';
                document.getElementById('p-amount').value = '';
            },

            addPhase: (e) => {
                e.preventDefault();
                const name = document.getElementById('s-name').value;
                const date = document.getElementById('s-date').value;
                const amount = document.getElementById('s-amount').value;
                store.addPhase(name, date, amount);
                document.getElementById('s-name').value = '';
                document.getElementById('s-amount').value = '';
            },

            quickPay: (pledgeId) => {
                const amount = prompt("Enter payment amount (KES):");
                if(amount && !isNaN(amount)) {
                    store.addTransaction({
                        amount: Number(amount),
                        name: 'Manual Entry',
                        ref: 'MAN-' + Date.now(),
                        matchedId: pledgeId
                    });
                }
            },

            // --- RECONCILER LOGIC ---
            parseSMS: (text) => {
                const sentences = text.split(/[\.!?]+/).filter(s => s.includes('Ksh') || s.includes('KES') || s.includes('received'));
                stagedTransactions = [];
                
                sentences.forEach(s => {
                    const amtMatch = s.match(/(?:Ksh|KES)\s?([0-9,]+(?:\.\d{2})?)/i);
                    if(!amtMatch) return;
                    const amount = parseFloat(amtMatch[1].replace(/,/g, ''));

                    let name = "Unknown";
                    const nameMatch = s.match(/from\s+([A-Za-z\s\.]+?)(?:\s+07\d{8}|\s+Account|\s+on\s+\d{1,2}\/)/i);
                    if(nameMatch) name = nameMatch[1].trim();

                    let ref = "N/A";
                    const refMatch = s.match(/(?:Account\s+Number|Confirmation\s+Code)\s+([A-Za-z0-9]+)/i);
                    if(refMatch) ref = refMatch[1];

                    // Matching Logic
                    let matchedId = null;
                    const match = store.data.pledges.find(p => 
                        name.toLowerCase().includes(p.name.toLowerCase()) || 
                        p.name.toLowerCase().includes(name.toLowerCase())
                    );

                    if(match) {
                        const remaining = match.amount - (match.redeemed || 0);
                        if(remaining >= amount) {
                            matchedId = match.id;
                            name = match.name;
                        }
                    }

                    stagedTransactions.push({ amount, name, ref, matchedId, id: Math.random() });
                });

                if(stagedTransactions.length > 0) {
                    document.getElementById('staged-container').classList.remove('hidden');
                    document.getElementById('staged-count').innerText = stagedTransactions.length;
                    const list = document.getElementById('staged-list');
                    list.innerHTML = '';
                    
                    stagedTransactions.forEach((t) => {
                        const badge = t.matchedId ? '<span class="badge badge-success">Pledge Matched ‚úÖ</span>' : '<span class="badge badge-warn">New Donor ‚ö†Ô∏è</span>';
                        list.innerHTML += `
                            <div style="padding: 10px; border-bottom: 1px solid #eee; display:flex; justify-content:space-between; align-items:center;">
                                <div>
                                    <strong>${t.name}</strong> - ${app.formatMoney(t.amount)} <br>
                                    <small class="text-sub">Ref: ${t.ref}</small>
                                </div>
                                ${badge}
                            </div>
                        `;
                    });
                } else {
                    document.getElementById('staged-container').classList.add('hidden');
                }
            },

            commitStaged: () => {
                stagedTransactions.forEach(t => store.addTransaction(t));
                app.clearStaged();
                alert(`Processed ${stagedTransactions.length} transactions!`);
            },

            clearStaged: () => {
                stagedTransactions = [];
                document.getElementById('staged-container').classList.add('hidden');
                document.getElementById('sms-input').innerText = 'Paste M-Pesa messages here...';
            },

            formatMoney: (num) => {
                return new Intl.NumberFormat('en-KE', { style: 'currency', currency: 'KES', maximumFractionDigits: 0 }).format(num);
            }
        };

        app.init();
    </script>
</body>
</html>
